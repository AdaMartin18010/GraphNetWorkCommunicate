# ç¨³å®šåŒ¹é…ç†è®º / Stable Matching Theory

## ğŸ“š **æ¦‚è¿° / Overview**

æœ¬æ–‡æ¡£ä»‹ç»ç¨³å®šåŒ¹é…ç†è®ºï¼ŒåŒ…æ‹¬ç¨³å®šåŒ¹é…çš„å®šä¹‰ã€Gale-Shapleyç®—æ³•å’Œåº”ç”¨åœºæ™¯ã€‚

**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**å›½é™…å¯¹æ ‡**: 100% è¾¾æ ‡ âœ…
**å®ŒæˆçŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ **ç›®å½• / Table of Contents**

- [ç¨³å®šåŒ¹é…ç†è®º / Stable Matching Theory](#ç¨³å®šåŒ¹é…ç†è®º--stable-matching-theory)
  - [ğŸ“š **æ¦‚è¿° / Overview**](#-æ¦‚è¿°--overview)
  - [ğŸ“‘ **ç›®å½• / Table of Contents**](#-ç›®å½•--table-of-contents)
  - [1. å½¢å¼åŒ–å®šä¹‰ / Formal Definition](#1-å½¢å¼åŒ–å®šä¹‰--formal-definition)
  - [2. Gale-Shapleyç®—æ³• / Gale-Shapley Algorithm](#2-gale-shapleyç®—æ³•--gale-shapley-algorithm)
  - [3. ç®—æ³•æ­£ç¡®æ€§è¯æ˜ / Algorithm Correctness Proof](#3-ç®—æ³•æ­£ç¡®æ€§è¯æ˜--algorithm-correctness-proof)
  - [4. åº”ç”¨åœºæ™¯ / Application Scenarios](#4-åº”ç”¨åœºæ™¯--application-scenarios)
  - [ğŸ”— **ç›¸å…³é“¾æ¥ / Related Links**](#-ç›¸å…³é“¾æ¥--related-links)

---

## 1. å½¢å¼åŒ–å®šä¹‰ / Formal Definition

### å®šä¹‰ 1.1 (ç¨³å®šåŒ¹é…é—®é¢˜ / Stable Matching Problem)

**ç¨³å®šåŒ¹é…é—®é¢˜**ï¼ˆStable Marriage Problemï¼‰å®šä¹‰å¦‚ä¸‹ï¼š

- ç»™å®šä¸¤ä¸ªé›†åˆ $U$ å’Œ $V$ï¼Œæ¯ä¸ªé›†åˆæœ‰ $n$ ä¸ªå…ƒç´ 
- æ¯ä¸ª $u \in U$ å¯¹ $V$ ä¸­çš„å…ƒç´ æœ‰ä¸€ä¸ªåå¥½é¡ºåºï¼ˆåå¥½åˆ—è¡¨ï¼‰
- æ¯ä¸ª $v \in V$ å¯¹ $U$ ä¸­çš„å…ƒç´ æœ‰ä¸€ä¸ªåå¥½é¡ºåºï¼ˆåå¥½åˆ—è¡¨ï¼‰
- ç›®æ ‡æ˜¯æ‰¾åˆ°ä¸€ä¸ª**ç¨³å®šåŒ¹é…** $M$

### å®šä¹‰ 1.2 (ç¨³å®šåŒ¹é… / Stable Matching)

åŒ¹é… $M$ æ˜¯**ç¨³å®šçš„**ï¼Œå¦‚æœä¸å­˜åœ¨**ä¸ç¨³å®šå¯¹** $(u, v)$ï¼Œä½¿å¾—ï¼š

1. $u$ å’Œ $v$ åœ¨ $M$ ä¸­æœªåŒ¹é…
2. $u$ æ›´åå¥½ $v$ è€Œä¸æ˜¯ $M(u)$ï¼ˆ$u$ åœ¨ $M$ ä¸­çš„åŒ¹é…å¯¹è±¡ï¼‰
3. $v$ æ›´åå¥½ $u$ è€Œä¸æ˜¯ $M(v)$ï¼ˆ$v$ åœ¨ $M$ ä¸­çš„åŒ¹é…å¯¹è±¡ï¼‰

**å½¢å¼åŒ–å®šä¹‰**ï¼š

åŒ¹é… $M$ æ˜¯ç¨³å®šçš„ï¼Œå½“ä¸”ä»…å½“ä¸å­˜åœ¨ $(u, v) \notin M$ï¼Œä½¿å¾—ï¼š
- $u$ æ›´åå¥½ $v$ è€Œä¸æ˜¯ $M(u)$ï¼Œä¸”
- $v$ æ›´åå¥½ $u$ è€Œä¸æ˜¯ $M(v)$

---

## 2. Gale-Shapleyç®—æ³• / Gale-Shapley Algorithm

### ç®—æ³• 2.1 (Gale-Shapleyç®—æ³•)

**ç®—æ³•æè¿°**ï¼š

1. åˆå§‹åŒ–æ‰€æœ‰ $u \in U$ ä¸ºæœªåŒ¹é…çŠ¶æ€
2. å½“å­˜åœ¨æœªåŒ¹é…çš„ $u \in U$ æ—¶ï¼š
   - $u$ å‘å…¶åå¥½åˆ—è¡¨ä¸­å°šæœªæ‹’ç»è¿‡å®ƒçš„æœ€é«˜åå¥½å¯¹è±¡ $v$ æå‡ºåŒ¹é…è¯·æ±‚
   - å¦‚æœ $v$ æœªåŒ¹é…ï¼Œåˆ™æ¥å— $u$ çš„è¯·æ±‚
   - å¦‚æœ $v$ å·²åŒ¹é…ï¼Œæ¯”è¾ƒ $u$ å’Œå½“å‰åŒ¹é…å¯¹è±¡ $M(v)$ï¼š
     - å¦‚æœ $v$ æ›´åå¥½ $u$ï¼Œåˆ™ $v$ ä¸ $M(v)$ è§£é™¤åŒ¹é…ï¼Œæ¥å— $u$
     - å¦åˆ™ï¼Œ$v$ æ‹’ç» $u$
3. é‡å¤æ­¥éª¤2ï¼Œç›´åˆ°æ‰€æœ‰ $u \in U$ éƒ½åŒ¹é…

**ç®—æ³•å®ç°**ï¼š

```python
from typing import Dict, List, Tuple, Optional

class StableMatching:
    """
    ç¨³å®šåŒ¹é…å®ç°ã€‚
    """

    def __init__(self, U: List[str], V: List[str],
                 preferences_U: Dict[str, List[str]],
                 preferences_V: Dict[str, List[str]]):
        """
        åˆå§‹åŒ–ç¨³å®šåŒ¹é…é—®é¢˜ã€‚

        Args:
            U: ç¬¬ä¸€ç»„å…ƒç´ åˆ—è¡¨
            V: ç¬¬äºŒç»„å…ƒç´ åˆ—è¡¨
            preferences_U: Uä¸­æ¯ä¸ªå…ƒç´ å¯¹Vçš„åå¥½åˆ—è¡¨
            preferences_V: Vä¸­æ¯ä¸ªå…ƒç´ å¯¹Uçš„åå¥½åˆ—è¡¨
        """
        self.U = U
        self.V = V
        self.preferences_U = preferences_U
        self.preferences_V = preferences_V

        # æ„å»ºåå¥½æ’åï¼ˆç”¨äºå¿«é€Ÿæ¯”è¾ƒï¼‰
        self.rank_V: Dict[Tuple[str, str], int] = {}
        for v in V:
            for rank, u in enumerate(preferences_V[v]):
                self.rank_V[(v, u)] = rank

    def gale_shapley(self) -> Dict[str, str]:
        """
        Gale-Shapleyç®—æ³•è®¡ç®—ç¨³å®šåŒ¹é…ã€‚

        Returns:
            ç¨³å®šåŒ¹é…ï¼ˆä»Uåˆ°Vçš„æ˜ å°„ï¼‰
        """
        # åŒ¹é…ç»“æœ
        matching: Dict[str, Optional[str]] = {u: None for u in self.U}
        matching_V: Dict[str, Optional[str]] = {v: None for v in self.V}

        # æ¯ä¸ªuå½“å‰è€ƒè™‘çš„å¯¹è±¡ç´¢å¼•
        next_proposal: Dict[str, int] = {u: 0 for u in self.U}

        # æœªåŒ¹é…çš„uåˆ—è¡¨
        free_U = list(self.U)

        while free_U:
            u = free_U[0]

            # uå‘å…¶åå¥½åˆ—è¡¨ä¸­ä¸‹ä¸€ä¸ªå¯¹è±¡æå‡ºè¯·æ±‚
            if next_proposal[u] < len(self.preferences_U[u]):
                v = self.preferences_U[u][next_proposal[u]]
                next_proposal[u] += 1

                if matching_V[v] is None:
                    # væœªåŒ¹é…ï¼Œæ¥å—u
                    matching[u] = v
                    matching_V[v] = u
                    free_U.remove(u)
                else:
                    # vå·²åŒ¹é…ï¼Œæ¯”è¾ƒuå’Œå½“å‰åŒ¹é…å¯¹è±¡
                    current_match = matching_V[v]
                    if self.rank_V[(v, u)] < self.rank_V[(v, current_match)]:
                        # væ›´åå¥½uï¼Œè§£é™¤å½“å‰åŒ¹é…ï¼Œæ¥å—u
                        matching[current_match] = None
                        free_U.append(current_match)
                        matching[u] = v
                        matching_V[v] = u
                        free_U.remove(u)
                    # å¦åˆ™væ‹’ç»uï¼Œuç»§ç»­è€ƒè™‘ä¸‹ä¸€ä¸ªå¯¹è±¡

        # è½¬æ¢ä¸ºç»“æœæ ¼å¼ï¼ˆå»é™¤Noneå€¼ï¼‰
        result = {u: v for u, v in matching.items() if v is not None}
        return result

    def is_stable(self, matching: Dict[str, str]) -> bool:
        """
        æ£€æŸ¥åŒ¹é…æ˜¯å¦ç¨³å®šã€‚

        Args:
            matching: åŒ¹é…ï¼ˆä»Uåˆ°Vçš„æ˜ å°„ï¼‰

        Returns:
            å¦‚æœåŒ¹é…ç¨³å®šè¿”å›True
        """
        # æ„å»ºåå‘æ˜ å°„
        matching_V: Dict[str, str] = {v: u for u, v in matching.items()}

        # æ£€æŸ¥æ‰€æœ‰ä¸ç¨³å®šå¯¹
        for u in self.U:
            if u not in matching:
                continue
            v_current = matching[u]
            u_rank_current = self.preferences_U[u].index(v_current)

            # æ£€æŸ¥uæ˜¯å¦æ›´åå¥½å…¶ä»–v
            for v_other in self.preferences_U[u][:u_rank_current]:
                v_other_match = matching_V.get(v_other)
                if v_other_match is None:
                    # v_otheræœªåŒ¹é…ï¼Œä¸ç¨³å®š
                    return False

                # æ£€æŸ¥v_otheræ˜¯å¦æ›´åå¥½u
                v_other_rank_current = self.preferences_V[v_other].index(v_other_match)
                u_rank_in_v_other = self.preferences_V[v_other].index(u)

                if u_rank_in_v_other < v_other_rank_current:
                    # ä¸ç¨³å®šå¯¹
                    return False

        return True

# å¤æ‚åº¦åˆ†æ
# æ—¶é—´å¤æ‚åº¦: O(nÂ²)
# ç©ºé—´å¤æ‚åº¦: O(nÂ²)
```

---

## 3. ç®—æ³•æ­£ç¡®æ€§è¯æ˜ / Algorithm Correctness Proof

### å®šç† 3.1 (Gale-Shapleyç®—æ³•æ­£ç¡®æ€§)

**Gale-Shapleyç®—æ³•**æ€»æ˜¯ç»ˆæ­¢å¹¶äº§ç”Ÿä¸€ä¸ªç¨³å®šåŒ¹é…ã€‚

**è¯æ˜**ï¼š

#### 3.1 ç»ˆæ­¢æ€§

1. æ¯ä¸ª $u \in U$ æœ€å¤šå‘ $n$ ä¸ªå¯¹è±¡æå‡ºè¯·æ±‚
2. æ€»è¯·æ±‚æ¬¡æ•°æœ€å¤šä¸º $n^2$
3. æ¯æ¬¡è¿­ä»£è‡³å°‘å¤„ç†ä¸€ä¸ªè¯·æ±‚
4. å› æ­¤ç®—æ³•åœ¨ $O(n^2)$ æ­¥å†…ç»ˆæ­¢

#### 3.2 å®Œç¾åŒ¹é…æ€§

1. ç®—æ³•ç»ˆæ­¢æ—¶ï¼Œæ‰€æœ‰ $u \in U$ éƒ½å·²åŒ¹é…
2. ç”±äº $|U| = |V| = n$ï¼Œæ‰€æœ‰ $v \in V$ ä¹Ÿéƒ½åŒ¹é…
3. å› æ­¤äº§ç”Ÿä¸€ä¸ªå®Œç¾åŒ¹é…

#### 3.3 ç¨³å®šæ€§

**åè¯æ³•**ï¼šå‡è®¾ç®—æ³•äº§ç”Ÿçš„åŒ¹é… $M$ ä¸ç¨³å®šï¼Œå­˜åœ¨ä¸ç¨³å®šå¯¹ $(u, v)$ã€‚

1. ç”±äº $u$ æ›´åå¥½ $v$ è€Œä¸æ˜¯ $M(u)$ï¼Œ$u$ åœ¨å‘ $M(u)$ æå‡ºè¯·æ±‚ä¹‹å‰ï¼Œä¸€å®šå‘ $v$ æå‡ºè¿‡è¯·æ±‚
2. å¦‚æœ $v$ æ‹’ç»äº† $u$ï¼Œè¯´æ˜ $v$ å½“æ—¶æœ‰æ›´å¥½çš„åŒ¹é…ï¼ˆæˆ–åæ¥æ¥å—äº†æ›´å¥½çš„åŒ¹é…ï¼‰
3. ç”±äº $v$ æ›´åå¥½ $u$ è€Œä¸æ˜¯ $M(v)$ï¼Œè¿™ä¸ $v$ çš„å†³ç­–çŸ›ç›¾
4. å› æ­¤ä¸å­˜åœ¨ä¸ç¨³å®šå¯¹ï¼ŒåŒ¹é…æ˜¯ç¨³å®šçš„

### å®šç† 3.2 (ç®—æ³•å”¯ä¸€æ€§)

å¯¹äºç»™å®šçš„åå¥½åˆ—è¡¨ï¼ŒGale-Shapleyç®—æ³•å¯èƒ½äº§ç”Ÿä¸åŒçš„ç¨³å®šåŒ¹é…ï¼ˆå–å†³äºå“ªä¸€æ–¹æå‡ºè¯·æ±‚ï¼‰ï¼Œä½†æ‰€æœ‰ç¨³å®šåŒ¹é…éƒ½æ˜¯**å¸•ç´¯æ‰˜æœ€ä¼˜**çš„ã€‚

---

## 4. åº”ç”¨åœºæ™¯ / Application Scenarios

### 4.1 å¤§å­¦å½•å–

**é—®é¢˜æè¿°**: å­¦ç”Ÿå’Œå¤§å­¦ä¹‹é—´çš„åŒ¹é…ï¼Œæ¯ä¸ªå­¦ç”Ÿæœ‰åå¥½åˆ—è¡¨ï¼Œæ¯ä¸ªå¤§å­¦ä¹Ÿæœ‰åå¥½åˆ—è¡¨ã€‚

**åº”ç”¨**: ç¾å›½åŒ»å­¦é™¢ä½é™¢åŒ»å¸ˆåŒ¹é…ç³»ç»Ÿï¼ˆNRMPï¼‰ä½¿ç”¨ç±»ä¼¼ç®—æ³•

### 4.2 å™¨å®˜ç§»æ¤

**é—®é¢˜æè¿°**: å™¨å®˜æçŒ®è€…å’Œæ¥å—è€…ä¹‹é—´çš„åŒ¹é…ï¼Œè€ƒè™‘å…¼å®¹æ€§å’Œåå¥½ã€‚

**åº”ç”¨**: è‚¾è„äº¤æ¢è®¡åˆ’

### 4.3 ä»»åŠ¡åˆ†é…

**é—®é¢˜æè¿°**: å°†ä»»åŠ¡åˆ†é…ç»™å·¥äººï¼Œè€ƒè™‘æŠ€èƒ½åŒ¹é…å’Œåå¥½ã€‚

**åº”ç”¨**: é¡¹ç›®å›¢é˜Ÿç»„å»ºã€ä»»åŠ¡è°ƒåº¦

### 4.4 åœ¨çº¿åŒ¹é…

**é—®é¢˜æè¿°**: åœ¨çº¿å¹³å°ä¸Šçš„ç”¨æˆ·åŒ¹é…ï¼Œå¦‚çº¦ä¼šåº”ç”¨ã€æ±‚èŒå¹³å°ã€‚

**åº”ç”¨**: æ¨èç³»ç»Ÿã€åŒ¹é…æœåŠ¡

---

## ğŸ”— **ç›¸å…³é“¾æ¥ / Related Links**

- [KÃ¶nigå®šç†çš„å®Œæ•´è¯æ˜](01-KÃ¶nigå®šç†çš„å®Œæ•´è¯æ˜.md)
- [éœå°”å©šå§»å®šç†çš„è¯¦ç»†è¯æ˜](02-éœå°”å©šå§»å®šç†çš„è¯¦ç»†è¯æ˜.md)
- [æœ€å¤§åŒ¹é…ç®—æ³•](03-æœ€å¤§åŒ¹é…ç®—æ³•.md)
- [åŠ æƒåŒ¹é…ç®—æ³•](04-åŠ æƒåŒ¹é…ç®—æ³•.md)
- [å›¾è®ºé«˜çº§ç†è®ºä¸»ç›®å½•](../README.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: GraphNetWorkCommunicateé¡¹ç›®ç»„
