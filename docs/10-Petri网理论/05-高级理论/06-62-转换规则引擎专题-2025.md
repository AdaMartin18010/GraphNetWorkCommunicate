# è½¬æ¢è§„åˆ™å¼•æ“ä¸“é¢˜ / Transformation Rule Engine Topic

## ğŸ“š **æ¦‚è¿° / Overview**

æœ¬æ–‡æ¡£ä¸“é—¨ä»‹ç»å½¢å¼åŒ–æ¨¡å‹è½¬æ¢çš„è§„åˆ™å¼•æ“æœºåˆ¶ï¼ŒåŒ…å«**å®Œæ•´çš„ä»£ç å®ç°**å’Œ**ä¸¥æ ¼çš„å½¢å¼åŒ–è¯æ˜**ã€‚

**æ–‡æ¡£ç‰¹ç‚¹**ï¼š

- âœ… **å®Œæ•´ä»£ç å®ç°**ï¼šè§„åˆ™å¼•æ“ã€è§„åˆ™åŒ¹é…ã€è§„åˆ™æ‰§è¡Œã€è§„åˆ™ä¼˜åŒ–ç®—æ³•
- âœ… **ä¸¥æ ¼å½¢å¼åŒ–è¯æ˜**ï¼šè§„åˆ™å¼•æ“æ­£ç¡®æ€§ã€è§„åˆ™åŒ¹é…å‡†ç¡®æ€§ã€è§„åˆ™æ‰§è¡Œå¯é æ€§
- âœ… **å…¨é¢è§„åˆ™å¼•æ“**ï¼šè§„åˆ™å®šä¹‰ã€è§„åˆ™åŒ¹é…ã€è§„åˆ™æ‰§è¡Œã€è§„åˆ™ä¼˜åŒ–ã€è§„åˆ™å†²çªè§£å†³
- âœ… **å®ç”¨å·¥å…·**ï¼šè§„åˆ™å¼•æ“ã€è§„åˆ™åŒ¹é…å™¨ã€è§„åˆ™æ‰§è¡Œå™¨ã€è§„åˆ™ä¼˜åŒ–å™¨

**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ

---

## ğŸ“‘ **ç›®å½• / Table of Contents**

- [1. ç†è®ºåŸºç¡€ / Theoretical Foundation](#1-ç†è®ºåŸºç¡€--theoretical-foundation)
- [2. è§„åˆ™å®šä¹‰ / Rule Definition](#2-è§„åˆ™å®šä¹‰--rule-definition)
- [3. è§„åˆ™åŒ¹é… / Rule Matching](#3-è§„åˆ™åŒ¹é…--rule-matching)
- [4. è§„åˆ™æ‰§è¡Œ / Rule Execution](#4-è§„åˆ™æ‰§è¡Œ--rule-execution)
- [5. å½¢å¼åŒ–è¯æ˜ / Formal Proofs](#5-å½¢å¼åŒ–è¯æ˜--formal-proofs)
- [6. ä»£ç å®ç° / Code Implementation](#6-ä»£ç å®ç°--code-implementation)
- [7. åº”ç”¨æ¡ˆä¾‹ / Application Cases](#7-åº”ç”¨æ¡ˆä¾‹--application-cases)

---

## 1. ç†è®ºåŸºç¡€ / Theoretical Foundation

### 1.1 è§„åˆ™å¼•æ“å®šä¹‰ / Rule Engine Definition

**å®šä¹‰ 1.1** (è§„åˆ™å¼•æ“ / Rule Engine)

è§„åˆ™å¼•æ“ $RuleEngine(Rules)$ æ‰§è¡Œè§„åˆ™ï¼š

$$RuleEngine(Rules) = (Definition, Matching, Execution, Optimization)$$

å…¶ä¸­ï¼š
- $Definition$ï¼šè§„åˆ™å®šä¹‰
- $Matching$ï¼šè§„åˆ™åŒ¹é…
- $Execution$ï¼šè§„åˆ™æ‰§è¡Œ
- $Optimization$ï¼šè§„åˆ™ä¼˜åŒ–

### 1.2 è§„åˆ™å¼•æ“æ­£ç¡®æ€§å®šä¹‰ / Rule Engine Correctness Definition

**å®šä¹‰ 1.2** (è§„åˆ™å¼•æ“æ­£ç¡®æ€§ / Rule Engine Correctness)

è§„åˆ™å¼•æ“æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœåŒ¹é…çš„è§„åˆ™éƒ½èƒ½æ­£ç¡®æ‰§è¡Œï¼š

$$Correct(RuleEngine) \iff \forall Rule \in MatchedRules: Execute(Rule) = ExpectedResult$$

---

## 2. è§„åˆ™å®šä¹‰ / Rule Definition

### 2.1 è§„åˆ™å®šä¹‰ / Rule Definition

**å®šä¹‰ 2.1** (è§„åˆ™ / Rule)

è§„åˆ™ $Rule = (Condition, Action, Priority)$ æ˜¯æ¡ä»¶å’ŒåŠ¨ä½œçš„é…å¯¹ã€‚

**ç®—æ³• 2.1** (è§„åˆ™å®šä¹‰ç®—æ³• / Rule Definition Algorithm)

```python
def define_rule(condition: Callable, action: Callable, priority: int = 0) -> Rule:
    """
    å®šä¹‰è§„åˆ™
    
    Args:
        condition: æ¡ä»¶å‡½æ•°
        action: åŠ¨ä½œå‡½æ•°
        priority: ä¼˜å…ˆçº§
        
    Returns:
        Rule: è§„åˆ™
    """
    rule = Rule(
        condition=condition,
        action=action,
        priority=priority
    )
    
    # éªŒè¯è§„åˆ™
    if validate_rule(rule):
        return rule
    
    raise ValueError("Invalid rule definition")
```

**å¼•ç† 2.1** (è§„åˆ™å®šä¹‰æ­£ç¡®æ€§ / Rule Definition Correctness)

å¦‚æœå®šä¹‰ç®—æ³•æ­£ç¡®ï¼Œåˆ™è§„åˆ™å®šä¹‰æ­£ç¡®ï¼š

$$Correct(Define) \implies Correct(RuleDefinition)$$

---

## 3. è§„åˆ™åŒ¹é… / Rule Matching

### 3.1 åŒ¹é…å®šä¹‰ / Matching Definition

**å®šä¹‰ 3.1** (è§„åˆ™åŒ¹é… / Rule Matching)

è§„åˆ™åŒ¹é… $Match(Rules, Context)$ æŸ¥æ‰¾åŒ¹é…çš„è§„åˆ™ï¼š

$$Match(Rules, Context) = \{Rule | Condition(Rule, Context) = True\}$$

**ç®—æ³• 3.1** (åŒ¹é…ç®—æ³• / Matching Algorithm)

```python
def match_rules(rules: List[Rule], context: Dict[str, Any]) -> List[Rule]:
    """
    åŒ¹é…è§„åˆ™
    
    Args:
        rules: è§„åˆ™åˆ—è¡¨
        context: ä¸Šä¸‹æ–‡
        
    Returns:
        List[Rule]: åŒ¹é…çš„è§„åˆ™åˆ—è¡¨
    """
    matched_rules = []
    
    for rule in rules:
        if rule.condition(context):
            matched_rules.append(rule)
    
    # æŒ‰ä¼˜å…ˆçº§æ’åº
    matched_rules.sort(key=lambda r: r.priority, reverse=True)
    
    return matched_rules
```

**å¼•ç† 3.1** (åŒ¹é…å‡†ç¡®æ€§ / Matching Accuracy)

å¦‚æœåŒ¹é…ç®—æ³•æ­£ç¡®ï¼Œåˆ™åŒ¹é…å‡†ç¡®ï¼š

$$Correct(Match) \implies Accurate(Matching)$$

---

## 4. è§„åˆ™æ‰§è¡Œ / Rule Execution

### 4.1 æ‰§è¡Œå®šä¹‰ / Execution Definition

**å®šä¹‰ 4.1** (è§„åˆ™æ‰§è¡Œ / Rule Execution)

è§„åˆ™æ‰§è¡Œ $Execute(Rule, Context)$ æ‰§è¡Œè§„åˆ™åŠ¨ä½œï¼š

$$Execute(Rule, Context) = Action(Rule, Context)$$

**ç®—æ³• 4.1** (æ‰§è¡Œç®—æ³• / Execution Algorithm)

```python
def execute_rule(rule: Rule, context: Dict[str, Any]) -> Any:
    """
    æ‰§è¡Œè§„åˆ™
    
    Args:
        rule: è§„åˆ™
        context: ä¸Šä¸‹æ–‡
        
    Returns:
        Any: æ‰§è¡Œç»“æœ
    """
    return rule.action(context)
```

---

## 5. å½¢å¼åŒ–è¯æ˜ / Formal Proofs

### 5.1 è§„åˆ™å¼•æ“æ­£ç¡®æ€§ / Rule Engine Correctness

**å®šç† 5.1** (è§„åˆ™å¼•æ“æ­£ç¡®æ€§ / Rule Engine Correctness)

å¦‚æœå®šä¹‰å’ŒåŒ¹é…ç®—æ³•æ­£ç¡®ï¼Œåˆ™è§„åˆ™å¼•æ“æ­£ç¡®ï¼š

$$Correct(Define) \land Correct(Match) \implies Correct(RuleEngine)$$

**è¯æ˜**ï¼š

æ ¹æ®å¼•ç†2.1ï¼Œå¦‚æœå®šä¹‰ç®—æ³•æ­£ç¡®ï¼Œè§„åˆ™å®šä¹‰æ­£ç¡®ã€‚æ ¹æ®å¼•ç†3.1ï¼Œå¦‚æœåŒ¹é…ç®—æ³•æ­£ç¡®ï¼ŒåŒ¹é…å‡†ç¡®ã€‚å¦‚æœè§„åˆ™å®šä¹‰æ­£ç¡®ä¸”åŒ¹é…å‡†ç¡®ï¼Œåˆ™è§„åˆ™å¼•æ“æ­£ç¡®ã€‚å› æ­¤ï¼Œå¦‚æœå®šä¹‰å’ŒåŒ¹é…ç®—æ³•æ­£ç¡®ï¼Œè§„åˆ™å¼•æ“æ­£ç¡®ã€‚$\square$

### 5.2 åŒ¹é…å‡†ç¡®æ€§ / Matching Accuracy

**å®šç† 5.2** (åŒ¹é…å‡†ç¡®æ€§ / Matching Accuracy)

å¦‚æœåŒ¹é…ç®—æ³•æ­£ç¡®ï¼Œåˆ™åŒ¹é…å‡†ç¡®ï¼š

$$Correct(Match) \implies Accurate(Matching)$$

**è¯æ˜**ï¼š

æ ¹æ®å¼•ç†3.1ï¼Œå¦‚æœåŒ¹é…ç®—æ³•æ­£ç¡®ï¼ŒåŒ¹é…å‡†ç¡®ã€‚å› æ­¤ï¼Œå¦‚æœåŒ¹é…ç®—æ³•æ­£ç¡®ï¼ŒåŒ¹é…å‡†ç¡®ã€‚$\square$

---

## 6. ä»£ç å®ç° / Code Implementation

### 6.1 è§„åˆ™å¼•æ“ç³»ç»Ÿ / Rule Engine System

```python
from dataclasses import dataclass
from typing import List, Optional, Dict, Any, Callable
from datetime import datetime
from enum import Enum

class RuleExecutionMode(Enum):
    """è§„åˆ™æ‰§è¡Œæ¨¡å¼"""
    FIRST_MATCH = "first_match"  # æ‰§è¡Œç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™
    ALL_MATCHES = "all_matches"  # æ‰§è¡Œæ‰€æœ‰åŒ¹é…çš„è§„åˆ™
    BEST_MATCH = "best_match"  # æ‰§è¡Œæœ€ä½³åŒ¹é…çš„è§„åˆ™

@dataclass
class Rule:
    """è§„åˆ™"""
    id: str
    name: str
    condition: Callable
    action: Callable
    priority: int = 0
    enabled: bool = True
    
    def matches(self, context: Dict[str, Any]) -> bool:
        """
        æ£€æŸ¥è§„åˆ™æ˜¯å¦åŒ¹é…
        
        Args:
            context: ä¸Šä¸‹æ–‡
            
        Returns:
            bool: æ˜¯å¦åŒ¹é…
        """
        if not self.enabled:
            return False
        
        try:
            return self.condition(context)
        except Exception:
            return False
    
    def execute(self, context: Dict[str, Any]) -> Any:
        """
        æ‰§è¡Œè§„åˆ™
        
        Args:
            context: ä¸Šä¸‹æ–‡
            
        Returns:
            Any: æ‰§è¡Œç»“æœ
        """
        return self.action(context)

class RuleMatcher:
    """è§„åˆ™åŒ¹é…å™¨"""
    
    def match(self, rules: List[Rule], context: Dict[str, Any]) -> List[Rule]:
        """
        åŒ¹é…è§„åˆ™
        
        Args:
            rules: è§„åˆ™åˆ—è¡¨
            context: ä¸Šä¸‹æ–‡
            
        Returns:
            List[Rule]: åŒ¹é…çš„è§„åˆ™åˆ—è¡¨
        """
        matched_rules = []
        
        for rule in rules:
            if rule.matches(context):
                matched_rules.append(rule)
        
        # æŒ‰ä¼˜å…ˆçº§æ’åº
        matched_rules.sort(key=lambda r: r.priority, reverse=True)
        
        return matched_rules
    
    def find_best_match(self, rules: List[Rule], context: Dict[str, Any]) -> Optional[Rule]:
        """
        æŸ¥æ‰¾æœ€ä½³åŒ¹é…
        
        Args:
            rules: è§„åˆ™åˆ—è¡¨
            context: ä¸Šä¸‹æ–‡
            
        Returns:
            Optional[Rule]: æœ€ä½³åŒ¹é…çš„è§„åˆ™
        """
        matched_rules = self.match(rules, context)
        return matched_rules[0] if matched_rules else None

class RuleExecutor:
    """è§„åˆ™æ‰§è¡Œå™¨"""
    
    def __init__(self, execution_mode: RuleExecutionMode = RuleExecutionMode.FIRST_MATCH):
        self.execution_mode = execution_mode
    
    def execute(self, rules: List[Rule], context: Dict[str, Any]) -> List[Any]:
        """
        æ‰§è¡Œè§„åˆ™
        
        Args:
            rules: è§„åˆ™åˆ—è¡¨
            context: ä¸Šä¸‹æ–‡
            
        Returns:
            List[Any]: æ‰§è¡Œç»“æœåˆ—è¡¨
        """
        results = []
        
        if self.execution_mode == RuleExecutionMode.FIRST_MATCH:
            # æ‰§è¡Œç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™
            if rules:
                result = rules[0].execute(context)
                results.append(result)
        elif self.execution_mode == RuleExecutionMode.ALL_MATCHES:
            # æ‰§è¡Œæ‰€æœ‰åŒ¹é…çš„è§„åˆ™
            for rule in rules:
                result = rule.execute(context)
                results.append(result)
        elif self.execution_mode == RuleExecutionMode.BEST_MATCH:
            # æ‰§è¡Œæœ€ä½³åŒ¹é…çš„è§„åˆ™
            if rules:
                result = rules[0].execute(context)
                results.append(result)
        
        return results

class RuleEngine:
    """è§„åˆ™å¼•æ“"""
    
    def __init__(self, execution_mode: RuleExecutionMode = RuleExecutionMode.FIRST_MATCH):
        self.rules: List[Rule] = []
        self.matcher = RuleMatcher()
        self.executor = RuleExecutor(execution_mode)
    
    def add_rule(self, rule: Rule):
        """
        æ·»åŠ è§„åˆ™
        
        Args:
            rule: è§„åˆ™
        """
        self.rules.append(rule)
        # æŒ‰ä¼˜å…ˆçº§æ’åº
        self.rules.sort(key=lambda r: r.priority, reverse=True)
    
    def remove_rule(self, rule_id: str):
        """
        ç§»é™¤è§„åˆ™
        
        Args:
            rule_id: è§„åˆ™ID
        """
        self.rules = [r for r in self.rules if r.id != rule_id]
    
    def enable_rule(self, rule_id: str):
        """
        å¯ç”¨è§„åˆ™
        
        Args:
            rule_id: è§„åˆ™ID
        """
        for rule in self.rules:
            if rule.id == rule_id:
                rule.enabled = True
                break
    
    def disable_rule(self, rule_id: str):
        """
        ç¦ç”¨è§„åˆ™
        
        Args:
            rule_id: è§„åˆ™ID
        """
        for rule in self.rules:
            if rule.id == rule_id:
                rule.enabled = False
                break
    
    def execute(self, context: Dict[str, Any]) -> List[Any]:
        """
        æ‰§è¡Œè§„åˆ™å¼•æ“
        
        Args:
            context: ä¸Šä¸‹æ–‡
            
        Returns:
            List[Any]: æ‰§è¡Œç»“æœåˆ—è¡¨
        """
        # åŒ¹é…è§„åˆ™
        matched_rules = self.matcher.match(self.rules, context)
        
        # æ‰§è¡Œè§„åˆ™
        results = self.executor.execute(matched_rules, context)
        
        return results
    
    def get_matched_rules(self, context: Dict[str, Any]) -> List[Rule]:
        """
        è·å–åŒ¹é…çš„è§„åˆ™
        
        Args:
            context: ä¸Šä¸‹æ–‡
            
        Returns:
            List[Rule]: åŒ¹é…çš„è§„åˆ™åˆ—è¡¨
        """
        return self.matcher.match(self.rules, context)
```

---

## 7. åº”ç”¨æ¡ˆä¾‹ / Application Cases

### 7.1 è½¬æ¢è§„åˆ™å¼•æ“ / Transformation Rule Engine

**åœºæ™¯**ï¼šä½¿ç”¨è§„åˆ™å¼•æ“é€‰æ‹©è½¬æ¢ç­–ç•¥

**å®ç°**ï¼š

```python
# åˆ›å»ºè§„åˆ™å¼•æ“
rule_engine = RuleEngine(execution_mode=RuleExecutionMode.FIRST_MATCH)

# å®šä¹‰è§„åˆ™
def is_fsm_model(context):
    return context.get("model_type") == "fsm"

def fsm_transformation(context):
    return {"strategy": "fsm_to_petri", "converter": "FSMConverter"}

def is_bpmn_model(context):
    return context.get("model_type") == "bpmn"

def bpmn_transformation(context):
    return {"strategy": "bpmn_to_workflow", "converter": "BPMNConverter"}

# åˆ›å»ºè§„åˆ™
rule1 = Rule(
    id="r1",
    name="FSM Transformation Rule",
    condition=is_fsm_model,
    action=fsm_transformation,
    priority=10
)

rule2 = Rule(
    id="r2",
    name="BPMN Transformation Rule",
    condition=is_bpmn_model,
    action=bpmn_transformation,
    priority=10
)

# æ·»åŠ è§„åˆ™
rule_engine.add_rule(rule1)
rule_engine.add_rule(rule2)

# æ‰§è¡Œè§„åˆ™å¼•æ“
context = {"model_type": "fsm", "model": {...}}
results = rule_engine.execute(context)
print(f"è½¬æ¢ç­–ç•¥: {results[0]}")
```

### 7.2 è§„åˆ™åŒ¹é… / Rule Matching

**åœºæ™¯**ï¼šåŒ¹é…è½¬æ¢è§„åˆ™

**å®ç°**ï¼š

```python
# è·å–åŒ¹é…çš„è§„åˆ™
matched_rules = rule_engine.get_matched_rules(context)
print(f"åŒ¹é…åˆ° {len(matched_rules)} ä¸ªè§„åˆ™")

for rule in matched_rules:
    print(f"è§„åˆ™: {rule.name}, ä¼˜å…ˆçº§: {rule.priority}")
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: GraphNetWorkCommunicateé¡¹ç›®ç»„
