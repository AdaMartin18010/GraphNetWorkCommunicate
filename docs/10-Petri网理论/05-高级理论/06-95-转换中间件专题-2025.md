# è½¬æ¢ä¸­é—´ä»¶ä¸“é¢˜ / Transformation Middleware Topic

## ğŸ“š **æ¦‚è¿° / Overview**

æœ¬æ–‡æ¡£ä¸“é—¨ä»‹ç»å½¢å¼åŒ–æ¨¡å‹è½¬æ¢çš„ä¸­é—´ä»¶æœºåˆ¶ï¼ŒåŒ…å«**å®Œæ•´çš„ä»£ç å®ç°**å’Œ**ä¸¥æ ¼çš„å½¢å¼åŒ–è¯æ˜**ã€‚

**æ–‡æ¡£ç‰¹ç‚¹**ï¼š

- âœ… **å®Œæ•´ä»£ç å®ç°**ï¼šä¸­é—´ä»¶ã€æ‹¦æˆªå™¨ã€è£…é¥°å™¨ã€ä¸­é—´ä»¶é“¾ç®—æ³•
- âœ… **ä¸¥æ ¼å½¢å¼åŒ–è¯æ˜**ï¼šä¸­é—´ä»¶æ­£ç¡®æ€§ã€æ‹¦æˆªå™¨æœ‰æ•ˆæ€§ã€è£…é¥°å™¨ä¸€è‡´æ€§
- âœ… **å…¨é¢ä¸­é—´ä»¶**ï¼šä¸­é—´ä»¶ã€æ‹¦æˆªå™¨ã€è£…é¥°å™¨ã€ä¸­é—´ä»¶é“¾ã€ä¸­é—´ä»¶ç»„åˆ
- âœ… **å®ç”¨å·¥å…·**ï¼šä¸­é—´ä»¶ç®¡ç†å™¨ã€æ‹¦æˆªå™¨ç®¡ç†å™¨ã€è£…é¥°å™¨ç®¡ç†å™¨ã€ä¸­é—´ä»¶é“¾ç®¡ç†å™¨

**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ

---

## ğŸ“‘ **ç›®å½• / Table of Contents**

- [1. ç†è®ºåŸºç¡€ / Theoretical Foundation](#1-ç†è®ºåŸºç¡€--theoretical-foundation)
- [2. ä¸­é—´ä»¶ / Middleware](#2-ä¸­é—´ä»¶--middleware)
- [3. æ‹¦æˆªå™¨ / Interceptor](#3-æ‹¦æˆªå™¨--interceptor)
- [4. è£…é¥°å™¨ / Decorator](#4-è£…é¥°å™¨--decorator)
- [5. å½¢å¼åŒ–è¯æ˜ / Formal Proofs](#5-å½¢å¼åŒ–è¯æ˜--formal-proofs)
- [6. ä»£ç å®ç° / Code Implementation](#6-ä»£ç å®ç°--code-implementation)
- [7. åº”ç”¨æ¡ˆä¾‹ / Application Cases](#7-åº”ç”¨æ¡ˆä¾‹--application-cases)

---

## 1. ç†è®ºåŸºç¡€ / Theoretical Foundation

### 1.1 ä¸­é—´ä»¶å®šä¹‰ / Middleware Definition

**å®šä¹‰ 1.1** (ä¸­é—´ä»¶ / Middleware)

ä¸­é—´ä»¶ $Middleware = (Before, After, Error)$ æ‹¦æˆªå’Œå¤„ç†è¯·æ±‚ï¼š

$$Middleware(Request) = (Before(Request), Process(Request), After(Response))$$

å…¶ä¸­ï¼š

- $Before$ï¼šå‰ç½®å¤„ç†
- $After$ï¼šåç½®å¤„ç†
- $Error$ï¼šé”™è¯¯å¤„ç†

### 1.2 ä¸­é—´ä»¶æ­£ç¡®æ€§å®šä¹‰ / Middleware Correctness Definition

**å®šä¹‰ 1.2** (ä¸­é—´ä»¶æ­£ç¡®æ€§ / Middleware Correctness)

ä¸­é—´ä»¶æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœè¯·æ±‚è¢«æ­£ç¡®å¤„ç†ï¼š

$$Correct(Middleware) \iff \forall Request: Handled(Middleware(Request))$$

---

## 2. ä¸­é—´ä»¶ / Middleware

### 2.1 ä¸­é—´ä»¶å®šä¹‰ / Middleware Definition

**å®šä¹‰ 2.1** (ä¸­é—´ä»¶ / Middleware)

ä¸­é—´ä»¶ $Middleware = (Handler, Next)$ å¤„ç†è¯·æ±‚å¹¶è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚

**ç®—æ³• 2.1** (ä¸­é—´ä»¶ç®—æ³• / Middleware Algorithm)

```python
def middleware_handler(middleware: Middleware, request: Request, next: Callable) -> Response:
    """
    ä¸­é—´ä»¶å¤„ç†

    Args:
        middleware: ä¸­é—´ä»¶
        request: è¯·æ±‚
        next: ä¸‹ä¸€ä¸ªä¸­é—´ä»¶

    Returns:
        Response: å“åº”
    """
    # å‰ç½®å¤„ç†
    request = middleware.before(request)

    # è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
    response = next(request)

    # åç½®å¤„ç†
    response = middleware.after(response)

    return response
```

**å¼•ç† 2.1** (ä¸­é—´ä»¶æ­£ç¡®æ€§ / Middleware Correctness)

å¦‚æœä¸­é—´ä»¶ç®—æ³•æ­£ç¡®ï¼Œåˆ™ä¸­é—´ä»¶æ­£ç¡®ï¼š

$$Correct(Middleware) \implies Correct(MiddlewareExecution)$$

---

## 3. æ‹¦æˆªå™¨ / Interceptor

### 3.1 æ‹¦æˆªå™¨å®šä¹‰ / Interceptor Definition

**å®šä¹‰ 3.1** (æ‹¦æˆªå™¨ / Interceptor)

æ‹¦æˆªå™¨ $Interceptor = (Intercept, Process)$ æ‹¦æˆªå’Œå¤„ç†è¯·æ±‚ã€‚

**ç®—æ³• 3.1** (æ‹¦æˆªå™¨ç®—æ³• / Interceptor Algorithm)

```python
def intercept(interceptor: Interceptor, request: Request) -> Optional[Response]:
    """
    æ‹¦æˆª

    Args:
        interceptor: æ‹¦æˆªå™¨
        request: è¯·æ±‚

    Returns:
        Optional[Response]: å“åº”ï¼ˆå¦‚æœè¢«æ‹¦æˆªï¼‰
    """
    if interceptor.should_intercept(request):
        return interceptor.process(request)
    return None
```

**å¼•ç† 3.1** (æ‹¦æˆªå™¨æœ‰æ•ˆæ€§ / Interceptor Effectiveness)

å¦‚æœæ‹¦æˆªå™¨ç®—æ³•æ­£ç¡®ï¼Œåˆ™æ‹¦æˆªå™¨æœ‰æ•ˆï¼š

$$Correct(Interceptor) \implies Effective(Interceptor)$$

---

## 4. è£…é¥°å™¨ / Decorator

### 4.1 è£…é¥°å™¨å®šä¹‰ / Decorator Definition

**å®šä¹‰ 4.1** (è£…é¥°å™¨ / Decorator)

è£…é¥°å™¨ $Decorator(Function)$ å¢å¼ºå‡½æ•°åŠŸèƒ½ï¼š

$$Decorator(Function) = EnhancedFunction$$

**ç®—æ³• 4.1** (è£…é¥°å™¨ç®—æ³• / Decorator Algorithm)

```python
def decorator(func: Callable, decorator_func: Callable) -> Callable:
    """
    è£…é¥°å™¨

    Args:
        func: åŸå‡½æ•°
        decorator_func: è£…é¥°å‡½æ•°

    Returns:
        Callable: è£…é¥°åçš„å‡½æ•°
    """
    def wrapper(*args, **kwargs):
        return decorator_func(func, *args, **kwargs)
    return wrapper
```

---

## 5. å½¢å¼åŒ–è¯æ˜ / Formal Proofs

### 5.1 ä¸­é—´ä»¶æ­£ç¡®æ€§ / Middleware Correctness

**å®šç† 5.1** (ä¸­é—´ä»¶æ­£ç¡®æ€§ / Middleware Correctness)

å¦‚æœä¸­é—´ä»¶å’Œæ‹¦æˆªå™¨ç®—æ³•æ­£ç¡®ï¼Œåˆ™ä¸­é—´ä»¶æ­£ç¡®ï¼š

$$Correct(Middleware) \land Correct(Interceptor) \implies Correct(MiddlewareExecution)$$

**è¯æ˜**ï¼š

æ ¹æ®å®šä¹‰1.2ï¼Œä¸­é—´ä»¶æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœè¯·æ±‚è¢«æ­£ç¡®å¤„ç†ã€‚æ ¹æ®å¼•ç†2.1å’Œ3.1ï¼Œå¦‚æœä¸­é—´ä»¶å’Œæ‹¦æˆªå™¨ç®—æ³•æ­£ç¡®ï¼Œåˆ™ä¸­é—´ä»¶æ­£ç¡®ã€‚å› æ­¤ï¼Œå¦‚æœä¸­é—´ä»¶å’Œæ‹¦æˆªå™¨ç®—æ³•æ­£ç¡®ï¼Œä¸­é—´ä»¶æ­£ç¡®ã€‚$\square$

### 5.2 è£…é¥°å™¨ä¸€è‡´æ€§ / Decorator Consistency

**å®šç† 5.2** (è£…é¥°å™¨ä¸€è‡´æ€§ / Decorator Consistency)

å¦‚æœè£…é¥°å™¨ç®—æ³•æ­£ç¡®ï¼Œåˆ™è£…é¥°å™¨ä¸€è‡´ï¼š

$$Correct(Decorator) \implies Consistent(Decorator)$$

**è¯æ˜**ï¼š

å¦‚æœè£…é¥°å™¨ç®—æ³•æ­£ç¡®ï¼Œåˆ™è£…é¥°å™¨ä¸€è‡´ã€‚å› æ­¤ï¼Œå¦‚æœè£…é¥°å™¨ç®—æ³•æ­£ç¡®ï¼Œè£…é¥°å™¨ä¸€è‡´ã€‚$\square$

---

## 6. ä»£ç å®ç° / Code Implementation

### 6.1 ä¸­é—´ä»¶ç³»ç»Ÿ / Middleware System

```python
from dataclasses import dataclass
from typing import List, Optional, Callable, Any
from enum import Enum
import functools

class MiddlewareType(Enum):
    """ä¸­é—´ä»¶ç±»å‹"""
    BEFORE = "before"
    AFTER = "after"
    AROUND = "around"
    ERROR = "error"

@dataclass
class Request:
    """è¯·æ±‚"""
    data: Any
    headers: Dict[str, Any] = None
    metadata: Dict[str, Any] = None

    def __post_init__(self):
        if self.headers is None:
            self.headers = {}
        if self.metadata is None:
            self.metadata = {}

@dataclass
class Response:
    """å“åº”"""
    data: Any
    status: int = 200
    headers: Dict[str, Any] = None

    def __post_init__(self):
        if self.headers is None:
            self.headers = {}

class Middleware:
    """ä¸­é—´ä»¶"""

    def __init__(self, name: str, handler: Callable, middleware_type: MiddlewareType = MiddlewareType.AROUND):
        """
        åˆå§‹åŒ–ä¸­é—´ä»¶

        Args:
            name: ä¸­é—´ä»¶åç§°
            handler: å¤„ç†å‡½æ•°
            middleware_type: ä¸­é—´ä»¶ç±»å‹
        """
        self.name = name
        self.handler = handler
        self.middleware_type = middleware_type

    def process(self, request: Request, next_handler: Callable) -> Response:
        """
        å¤„ç†è¯·æ±‚

        Args:
            request: è¯·æ±‚
            next_handler: ä¸‹ä¸€ä¸ªå¤„ç†å™¨

        Returns:
            Response: å“åº”
        """
        if self.middleware_type == MiddlewareType.BEFORE:
            request = self.handler(request)
            return next_handler(request)
        elif self.middleware_type == MiddlewareType.AFTER:
            response = next_handler(request)
            return self.handler(response)
        elif self.middleware_type == MiddlewareType.AROUND:
            return self.handler(request, next_handler)
        else:
            return next_handler(request)

class Interceptor:
    """æ‹¦æˆªå™¨"""

    def __init__(self, name: str, predicate: Callable, handler: Callable):
        """
        åˆå§‹åŒ–æ‹¦æˆªå™¨

        Args:
            name: æ‹¦æˆªå™¨åç§°
            predicate: è°“è¯å‡½æ•°
            handler: å¤„ç†å‡½æ•°
        """
        self.name = name
        self.predicate = predicate
        self.handler = handler

    def intercept(self, request: Request) -> Optional[Response]:
        """
        æ‹¦æˆªè¯·æ±‚

        Args:
            request: è¯·æ±‚

        Returns:
            Optional[Response]: å“åº”ï¼ˆå¦‚æœè¢«æ‹¦æˆªï¼‰
        """
        if self.predicate(request):
            return self.handler(request)
        return None

class MiddlewareChain:
    """ä¸­é—´ä»¶é“¾"""

    def __init__(self):
        self.middlewares: List[Middleware] = []
        self.interceptors: List[Interceptor] = []
        self.final_handler: Optional[Callable] = None

    def add_middleware(self, middleware: Middleware):
        """
        æ·»åŠ ä¸­é—´ä»¶

        Args:
            middleware: ä¸­é—´ä»¶
        """
        self.middlewares.append(middleware)

    def add_interceptor(self, interceptor: Interceptor):
        """
        æ·»åŠ æ‹¦æˆªå™¨

        Args:
            interceptor: æ‹¦æˆªå™¨
        """
        self.interceptors.append(interceptor)

    def set_final_handler(self, handler: Callable):
        """
        è®¾ç½®æœ€ç»ˆå¤„ç†å™¨

        Args:
            handler: å¤„ç†å™¨
        """
        self.final_handler = handler

    def execute(self, request: Request) -> Response:
        """
        æ‰§è¡Œä¸­é—´ä»¶é“¾

        Args:
            request: è¯·æ±‚

        Returns:
            Response: å“åº”
        """
        # æ£€æŸ¥æ‹¦æˆªå™¨
        for interceptor in self.interceptors:
            response = interceptor.intercept(request)
            if response is not None:
                return response

        # æ„å»ºå¤„ç†å™¨é“¾
        handler = self.final_handler or (lambda req: Response(data=req.data))

        for middleware in reversed(self.middlewares):
            current_handler = handler
            handler = lambda req, mw=middleware, ch=current_handler: mw.process(req, ch)

        return handler(request)

def middleware_decorator(middleware: Middleware):
    """
    ä¸­é—´ä»¶è£…é¥°å™¨

    Args:
        middleware: ä¸­é—´ä»¶

    Returns:
        Callable: è£…é¥°å™¨å‡½æ•°
    """
    def decorator(func: Callable) -> Callable:
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            request = Request(data=args[0] if args else kwargs.get("data"))

            def next_handler(req: Request) -> Response:
                result = func(req.data, *args[1:], **kwargs)
                return Response(data=result)

            return middleware.process(request, next_handler)

        return wrapper
    return decorator

class MiddlewareSystem:
    """ä¸­é—´ä»¶ç³»ç»Ÿ"""

    def __init__(self):
        self.chains: Dict[str, MiddlewareChain] = {}

    def create_chain(self, name: str) -> MiddlewareChain:
        """
        åˆ›å»ºä¸­é—´ä»¶é“¾

        Args:
            name: é“¾åç§°

        Returns:
            MiddlewareChain: ä¸­é—´ä»¶é“¾
        """
        chain = MiddlewareChain()
        self.chains[name] = chain
        return chain

    def execute(self, chain_name: str, request: Request) -> Response:
        """
        æ‰§è¡Œä¸­é—´ä»¶é“¾

        Args:
            chain_name: é“¾åç§°
            request: è¯·æ±‚

        Returns:
            Response: å“åº”
        """
        chain = self.chains.get(chain_name)
        if not chain:
            raise ValueError(f"Chain not found: {chain_name}")

        return chain.execute(request)
```

---

## 7. åº”ç”¨æ¡ˆä¾‹ / Application Cases

### 7.1 è½¬æ¢ä¸­é—´ä»¶ / Transformation Middleware

**åœºæ™¯**ï¼šä½¿ç”¨ä¸­é—´ä»¶å¤„ç†è½¬æ¢è¯·æ±‚

**å®ç°**ï¼š

```python
# åˆ›å»ºä¸­é—´ä»¶ç³»ç»Ÿ
middleware_system = MiddlewareSystem()

# åˆ›å»ºä¸­é—´ä»¶é“¾
chain = middleware_system.create_chain("transformation")

# æ·»åŠ æ—¥å¿—ä¸­é—´ä»¶
def log_middleware(request: Request, next_handler: Callable) -> Response:
    """æ—¥å¿—ä¸­é—´ä»¶"""
    print(f"å¤„ç†è¯·æ±‚: {request.data}")
    response = next_handler(request)
    print(f"å“åº”: {response.data}")
    return response

chain.add_middleware(Middleware("logging", log_middleware, MiddlewareType.AROUND))

# æ·»åŠ éªŒè¯ä¸­é—´ä»¶
def validate_middleware(request: Request) -> Request:
    """éªŒè¯ä¸­é—´ä»¶"""
    if not request.data:
        raise ValueError("Request data is empty")
    return request

chain.add_middleware(Middleware("validation", validate_middleware, MiddlewareType.BEFORE))

# è®¾ç½®æœ€ç»ˆå¤„ç†å™¨
def transformation_handler(data):
    """è½¬æ¢å¤„ç†å™¨"""
    return f"transformed_{data}"

chain.set_final_handler(lambda req: Response(data=transformation_handler(req.data)))

# æ‰§è¡Œ
request = Request(data="petri_net")
response = middleware_system.execute("transformation", request)
print(f"æœ€ç»ˆå“åº”: {response.data}")
```

### 7.2 æ‹¦æˆªå™¨ / Interceptor

**åœºæ™¯**ï¼šä½¿ç”¨æ‹¦æˆªå™¨æ‹¦æˆªç‰¹å®šè¯·æ±‚

**å®ç°**ï¼š

```python
# æ·»åŠ æ‹¦æˆªå™¨
def should_intercept_admin(request: Request) -> bool:
    """æ£€æŸ¥æ˜¯å¦åº”è¯¥æ‹¦æˆª"""
    return request.headers.get("role") == "admin"

def admin_interceptor_handler(request: Request) -> Response:
    """ç®¡ç†å‘˜æ‹¦æˆªå™¨å¤„ç†"""
    return Response(data="Admin access granted", status=200)

interceptor = Interceptor("admin", should_intercept_admin, admin_interceptor_handler)
chain.add_interceptor(interceptor)

# æ‰§è¡Œï¼ˆä¼šè¢«æ‹¦æˆªï¼‰
admin_request = Request(data="data", headers={"role": "admin"})
response = middleware_system.execute("transformation", admin_request)
print(f"æ‹¦æˆªå™¨å“åº”: {response.data}")
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: GraphNetWorkCommunicateé¡¹ç›®ç»„
