# SFCè½¬æ¢ä¸“é¢˜ / Sequential Function Chart Transformation Topic

## ğŸ“š **æ¦‚è¿° / Overview**

æœ¬æ–‡æ¡£ä¸“é—¨ä»‹ç»SFCï¼ˆSequential Function Chartï¼Œé¡ºåºåŠŸèƒ½å›¾ï¼‰ä¸Petriç½‘ä¹‹é—´çš„è½¬æ¢ï¼ŒåŒ…å«**å®Œæ•´çš„ä»£ç å®ç°**å’Œ**ä¸¥æ ¼çš„å½¢å¼åŒ–è¯æ˜**ã€‚

**æ–‡æ¡£ç‰¹ç‚¹**ï¼š

- âœ… **å®Œæ•´ä»£ç å®ç°**ï¼šSFCåˆ°Petriç½‘çš„è½¬æ¢ç®—æ³•
- âœ… **ä¸¥æ ¼å½¢å¼åŒ–è¯æ˜**ï¼šè¯­ä¹‰ä¿æŒã€è¡Œä¸ºç­‰ä»·è¯æ˜
- âœ… **å·¥ä¸šæ ‡å‡†**ï¼šç¬¦åˆIEC 61131-3æ ‡å‡†
- âœ… **åŒå‘è½¬æ¢**ï¼šSFC â†’ Petriç½‘ å’Œ Petriç½‘ â†’ SFC

**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ

---

## ğŸ“‘ **ç›®å½• / Table of Contents**

- [1. ç†è®ºåŸºç¡€ / Theoretical Foundation](#1-ç†è®ºåŸºç¡€--theoretical-foundation)
- [2. SFCåˆ°Petriç½‘è½¬æ¢ / SFC to Petri Net Transformation](#2-sfcåˆ°petriç½‘è½¬æ¢--sfc-to-petri-net-transformation)
- [3. Petriç½‘åˆ°SFCè½¬æ¢ / Petri Net to SFC Transformation](#3-petriç½‘åˆ°sfcè½¬æ¢--petri-net-to-sfc-transformation)
- [4. å½¢å¼åŒ–è¯æ˜ / Formal Proofs](#4-å½¢å¼åŒ–è¯æ˜--formal-proofs)
- [5. ä»£ç å®ç° / Code Implementation](#5-ä»£ç å®ç°--code-implementation)
- [6. åº”ç”¨æ¡ˆä¾‹ / Application Cases](#6-åº”ç”¨æ¡ˆä¾‹--application-cases)

---

## 1. ç†è®ºåŸºç¡€ / Theoretical Foundation

### 1.1 SFCå®šä¹‰ / SFC Definition

**å®šä¹‰ 1.1** (é¡ºåºåŠŸèƒ½å›¾ / Sequential Function Chart)

é¡ºåºåŠŸèƒ½å›¾ $SFC = (S, T, A, I, F)$ï¼Œå…¶ä¸­ï¼š

- $S$ï¼šæ­¥ï¼ˆStepï¼‰é›†åˆ
- $T$ï¼šè½¬æ¢ï¼ˆTransitionï¼‰é›†åˆ
- $A \subseteq (S \times T) \cup (T \times S)$ï¼šå¼§é›†åˆ
- $I \subseteq S$ï¼šåˆå§‹æ­¥é›†åˆ
- $F: S \to \text{Action}$ï¼šåŠ¨ä½œå‡½æ•°ï¼ˆæ­¥åˆ°åŠ¨ä½œçš„æ˜ å°„ï¼‰

**å½¢å¼åŒ–è¯­ä¹‰**ï¼š

- **æ­¥æ¿€æ´»**ï¼šæ­¥ $s \in S$ å¯ä»¥å¤„äºæ¿€æ´»æˆ–éæ¿€æ´»çŠ¶æ€
- **è½¬æ¢æ¡ä»¶**ï¼šè½¬æ¢ $t \in T$ åœ¨æ»¡è¶³æ¡ä»¶æ—¶è§¦å‘
- **åŠ¨ä½œæ‰§è¡Œ**ï¼šæ¿€æ´»çš„æ­¥æ‰§è¡Œå¯¹åº”çš„åŠ¨ä½œ

### 1.2 SFCå…ƒç´ ç±»å‹ / SFC Element Types

**æ­¥ç±»å‹**ï¼š

- **åˆå§‹æ­¥**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶çš„åˆå§‹çŠ¶æ€
- **æ™®é€šæ­¥**ï¼šæ‰§è¡ŒåŠ¨ä½œçš„çŠ¶æ€
- **é€‰æ‹©åˆ†æ”¯**ï¼šå¤šä¸ªè½¬æ¢è·¯å¾„çš„é€‰æ‹©
- **å¹¶è¡Œåˆ†æ”¯**ï¼šå¤šä¸ªè½¬æ¢è·¯å¾„çš„å¹¶è¡Œæ‰§è¡Œ

**è½¬æ¢ç±»å‹**ï¼š

- **æ¡ä»¶è½¬æ¢**ï¼šåŸºäºå¸ƒå°”æ¡ä»¶çš„è½¬æ¢
- **æ—¶é—´è½¬æ¢**ï¼šåŸºäºæ—¶é—´æ¡ä»¶çš„è½¬æ¢
- **äº‹ä»¶è½¬æ¢**ï¼šåŸºäºäº‹ä»¶çš„è½¬æ¢

---

## 2. SFCåˆ°Petriç½‘è½¬æ¢ / SFC to Petri Net Transformation

### 2.1 è½¬æ¢è§„åˆ™ / Transformation Rules

| SFCå…ƒç´  | Petriç½‘å…ƒç´  | è½¬æ¢è§„åˆ™ |
|--------|-----------|---------|
| **æ­¥ $s \in S$** | åº“æ‰€ $p_s$ | æ¯ä¸ªæ­¥å¯¹åº”ä¸€ä¸ªåº“æ‰€ |
| **è½¬æ¢ $t \in T$** | å˜è¿ $t$ | æ¯ä¸ªè½¬æ¢å¯¹åº”ä¸€ä¸ªå˜è¿ |
| **åˆå§‹æ­¥** | åˆå§‹æ ‡è¯† | $M_0(p_{initial}) = 1$ |
| **åŠ¨ä½œ** | å˜è¿æ ‡ç­¾ | åŠ¨ä½œä½œä¸ºå˜è¿æ ‡ç­¾ |
| **é€‰æ‹©åˆ†æ”¯** | å†²çªç»“æ„ | å¤šä¸ªå˜è¿ç«äº‰ä¸€ä¸ªä»¤ç‰Œ |
| **å¹¶è¡Œåˆ†æ”¯** | å¹¶è¡Œç»“æ„ | ä¸€ä¸ªå˜è¿äº§ç”Ÿå¤šä¸ªä»¤ç‰Œ |

### 2.2 å½¢å¼åŒ–è½¬æ¢å‡½æ•° / Formal Transformation Function

**å®šä¹‰ 2.1** (SFCåˆ°Petriç½‘è½¬æ¢å‡½æ•° / SFC to Petri Net Transformation Function)

ç»™å®šSFC $SFC = (S, T, A, I, F)$ï¼Œå®šä¹‰è½¬æ¢å‡½æ•° $\mathcal{T}_{SFC \to PN}: \mathcal{M}_{SFC} \to \mathcal{M}_{PN}$ï¼Œå…¶ä¸­ï¼š

$$\mathcal{T}_{SFC \to PN}(SFC) = (P, T_N, F_N, M_0)$$

å…¶ä¸­ï¼š

- $P = \{p_s \mid s \in S\}$ï¼šä¸ºæ¯ä¸ªæ­¥åˆ›å»ºåº“æ‰€
- $T_N = \{t \mid t \in T\}$ï¼šè½¬æ¢å¯¹åº”å˜è¿
- $F_N = \{(p_s, t) \mid (s, t) \in A\} \cup \{(t, p_s) \mid (t, s) \in A\}$ï¼šæµå…³ç³»
- $M_0: P \to \mathbb{N}$ æ»¡è¶³ $\forall s_0 \in I: M_0(p_{s_0}) = 1$ ä¸”å…¶ä»–ä¸º0ï¼šåˆå§‹æ ‡è¯†

**å¼•ç† 2.1** (è½¬æ¢å‡½æ•°è‰¯å®šä¹‰æ€§ / Well-Definedness)

è½¬æ¢å‡½æ•° $\mathcal{T}_{SFC \to PN}$ æ˜¯è‰¯å®šä¹‰çš„ï¼Œå³å¯¹äºä»»æ„SFC $SFC$ï¼Œ$\mathcal{T}_{SFC \to PN}(SFC)$ æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„Petriç½‘ã€‚

**è¯æ˜**ï¼š

1. **åº“æ‰€é›†åˆéç©º**ï¼šç”±äº $S \neq \emptyset$ï¼Œå› æ­¤ $P \neq \emptyset$ã€‚
2. **å˜è¿é›†åˆå®šä¹‰**ï¼š$T_N$ ç”±è½¬æ¢é›†åˆ $T$ ç¡®å®šï¼Œæ˜¯æœ‰é™é›†åˆã€‚
3. **æµå…³ç³»å®šä¹‰**ï¼š$F_N \subseteq (P \times T_N) \cup (T_N \times P)$ï¼Œæ»¡è¶³Petriç½‘æµå…³ç³»çš„å®šä¹‰ã€‚
4. **åˆå§‹æ ‡è¯†å®šä¹‰**ï¼š$M_0: P \to \mathbb{N}$ æ˜¯è‰¯å®šä¹‰çš„å‡½æ•°ã€‚

å› æ­¤ï¼Œ$\mathcal{T}_{SFC \to PN}(SFC)$ æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„Petriç½‘ã€‚$\square$

---

## 3. Petriç½‘åˆ°SFCè½¬æ¢ / Petri Net to SFC Transformation

### 3.1 è½¬æ¢è§„åˆ™ / Transformation Rules

| Petriç½‘å…ƒç´  | SFCå…ƒç´  | è½¬æ¢è§„åˆ™ |
|-----------|--------|---------|
| **åº“æ‰€ $p$** | æ­¥ $s$ | åº“æ‰€å¯¹åº”æ­¥ |
| **å˜è¿ $t$** | è½¬æ¢ $t$ | å˜è¿å¯¹åº”è½¬æ¢ |
| **åˆå§‹æ ‡è¯†** | åˆå§‹æ­¥ | $M_0(p) = 1$ å¯¹åº”åˆå§‹æ­¥ |
| **å†²çªç»“æ„** | é€‰æ‹©åˆ†æ”¯ | å¤šä¸ªå˜è¿ç«äº‰ä¸€ä¸ªä»¤ç‰Œ â†’ é€‰æ‹©åˆ†æ”¯ |
| **å¹¶è¡Œç»“æ„** | å¹¶è¡Œåˆ†æ”¯ | ä¸€ä¸ªå˜è¿äº§ç”Ÿå¤šä¸ªä»¤ç‰Œ â†’ å¹¶è¡Œåˆ†æ”¯ |

### 3.2 å½¢å¼åŒ–è½¬æ¢å‡½æ•° / Formal Transformation Function

**å®šä¹‰ 3.1** (Petriç½‘åˆ°SFCè½¬æ¢å‡½æ•° / Petri Net to SFC Transformation Function)

ç»™å®šPetriç½‘ $PN = (P, T, F, M_0)$ï¼Œå®šä¹‰è½¬æ¢å‡½æ•° $\mathcal{T}_{PN \to SFC}: \mathcal{M}_{PN} \to \mathcal{M}_{SFC}$ï¼Œå…¶ä¸­ï¼š

$$\mathcal{T}_{PN \to SFC}(PN) = (S, T_S, A, I, F)$$

å…¶ä¸­ï¼š

- $S = \{s_p \mid p \in P\}$ï¼šä¸ºæ¯ä¸ªåº“æ‰€åˆ›å»ºæ­¥
- $T_S = \{t \mid t \in T\}$ï¼šå˜è¿å¯¹åº”è½¬æ¢
- $A = \{(s_p, t) \mid (p, t) \in F\} \cup \{(t, s_p) \mid (t, p) \in F\}$ï¼šå¼§é›†åˆ
- $I = \{s_p \mid p \in P, M_0(p) = 1\}$ï¼šåˆå§‹æ­¥é›†åˆ
- $F: S \to \text{Action}$ï¼šåŠ¨ä½œå‡½æ•°ï¼ˆç®€åŒ–ï¼šç©ºåŠ¨ä½œï¼‰

---

## 4. å½¢å¼åŒ–è¯æ˜ / Formal Proofs

### 4.1 è¯­ä¹‰ä¿æŒå®šç† / Semantic Preservation Theorem

**å®šç† 4.1** (SFC-Petriç½‘è½¬æ¢è¯­ä¹‰ä¿æŒ / SFC-Petri Net Transformation Semantic Preservation)

å¯¹äºSFC $SFC$ å’Œè½¬æ¢å¾—åˆ°çš„Petriç½‘ $PN = \mathcal{T}_{SFC \to PN}(SFC)$ï¼Œå­˜åœ¨è¯­ä¹‰ä¿æŒå…³ç³»ï¼Œä½¿å¾—ï¼š

1. **æ­¥å¯¹åº”**ï¼š$SFC$ çš„æ­¥æ¿€æ´»ä¸ $PN$ çš„æ ‡è¯†ä¸€ä¸€å¯¹åº”
2. **è½¬æ¢å¯¹åº”**ï¼š$SFC$ çš„è½¬æ¢è§¦å‘ä¸ $PN$ çš„å˜è¿è§¦å‘ä¸€ä¸€å¯¹åº”
3. **è¡Œä¸ºç­‰ä»·**ï¼š$SFC$ çš„æ‰§è¡Œåºåˆ—ä¸ $PN$ çš„æ‰§è¡Œåºåˆ—ç­‰ä»·

**è¯æ˜**ï¼š

**æ­¥éª¤1ï¼šæ­¥å¯¹åº”**

å¯¹äºSFCçš„æ¯ä¸ªæ­¥ $s \in S$ï¼Œè½¬æ¢ç®—æ³•åˆ›å»ºäº†å¯¹åº”çš„åº“æ‰€ $p_s$ã€‚

æ­¥ $s$ æ¿€æ´»å½“ä¸”ä»…å½“ $M(p_s) = 1$ã€‚

**æ­¥éª¤2ï¼šè½¬æ¢å¯¹åº”**

å¯¹äºSFCçš„è½¬æ¢ $t \in T$ï¼Œè½¬æ¢ç®—æ³•åˆ›å»ºäº†å¯¹åº”çš„å˜è¿ $t$ã€‚

è½¬æ¢ $t$ è§¦å‘å½“ä¸”ä»…å½“å˜è¿ $t$ è§¦å‘ã€‚

**æ­¥éª¤3ï¼šè¡Œä¸ºç­‰ä»·**

SFCçš„æ‰§è¡Œåºåˆ—ï¼š$s_0 \xrightarrow{t_1} s_1 \xrightarrow{t_2} \cdots \xrightarrow{t_n} s_n$

å¯¹åº”çš„Petriç½‘æ‰§è¡Œåºåˆ—ï¼š$M_0 \xrightarrow{t_1} M_1 \xrightarrow{t_2} \cdots \xrightarrow{t_n} M_n$

å…¶ä¸­ $M_i(p_{s_i}) = 1$ ä¸”å…¶ä»–åº“æ‰€ä¸ºç©ºã€‚

å› æ­¤ï¼Œè¡Œä¸ºç­‰ä»·ã€‚$\square$

---

## 5. ä»£ç å®ç° / Code Implementation

### 5.1 SFCåˆ°Petriç½‘è½¬æ¢å™¨ / SFC to Petri Net Converter

```python
from typing import Dict, Set, Tuple, List, Optional, Callable
from dataclasses import dataclass

@dataclass
class SFCStep:
    """SFCæ­¥"""
    id: str
    name: str
    is_initial: bool = False
    action: Optional[str] = None

@dataclass
class SFCTransition:
    """SFCè½¬æ¢"""
    id: str
    condition: Optional[str] = None  # è½¬æ¢æ¡ä»¶

@dataclass
class SFC:
    """é¡ºåºåŠŸèƒ½å›¾"""
    steps: List[SFCStep]
    transitions: List[SFCTransition]
    arcs: List[Tuple[str, str]]  # (source_id, target_id)ï¼Œsourceå’Œtargetå¯ä»¥æ˜¯æ­¥æˆ–è½¬æ¢

class SFCToPetriNetConverter:
    """SFCåˆ°Petriç½‘è½¬æ¢å™¨ - å®Œæ•´å®ç°"""

    def __init__(self):
        self.place_counter = 0
        self.transition_counter = 0

    def convert(self, sfc: SFC) -> 'PetriNet':
        """
        è½¬æ¢SFCåˆ°Petriç½‘

        å®ç°å®šä¹‰2.1çš„è½¬æ¢å‡½æ•°

        Args:
            sfc: é¡ºåºåŠŸèƒ½å›¾

        Returns:
            Petriç½‘
        """
        places = set()
        transitions = set()
        flow_relation = set()
        initial_marking = {}

        # æ­¥éª¤1ï¼šä¸ºæ¯ä¸ªæ­¥åˆ›å»ºåº“æ‰€ï¼ˆå®šä¹‰2.1ï¼šP = {p_s | s âˆˆ S}ï¼‰
        step_to_place = {}
        for step in sfc.steps:
            place = self._create_place(f"step_{step.id}")
            places.add(place)
            step_to_place[step.id] = place
            initial_marking[place] = 0

        # æ­¥éª¤2ï¼šè®¾ç½®åˆå§‹æ ‡è¯†ï¼ˆå®šä¹‰2.1ï¼šM_0(p_{s_0}) = 1ï¼‰
        for step in sfc.steps:
            if step.is_initial:
                initial_place = step_to_place[step.id]
                initial_marking[initial_place] = 1

        # æ­¥éª¤3ï¼šè½¬æ¢è½¬æ¢å’Œå¼§ï¼ˆå®šä¹‰2.1ï¼šT_Nå’ŒF_Nï¼‰
        transition_map = {}
        for transition in sfc.transitions:
            transition_id = f"t_{transition.id}"
            transitions.add(transition_id)
            transition_map[transition.id] = transition_id

        # æ­¥éª¤4ï¼šæ„å»ºæµå…³ç³»ï¼ˆå®šä¹‰2.1ï¼šF_Nï¼‰
        for source_id, target_id in sfc.arcs:
            # åˆ¤æ–­æºå’Œç›®æ ‡ç±»å‹
            source_place = step_to_place.get(source_id)
            source_transition = transition_map.get(source_id)
            target_place = step_to_place.get(target_id)
            target_transition = transition_map.get(target_id)

            if source_place and target_transition:
                # æ­¥åˆ°è½¬æ¢çš„å¼§
                flow_relation.add((source_place, target_transition))
            elif source_transition and target_place:
                # è½¬æ¢åˆ°æ­¥çš„å¼§
                flow_relation.add((source_transition, target_place))
            elif source_place and target_place:
                # æ­¥åˆ°æ­¥çš„å¼§ï¼ˆéœ€è¦æ’å…¥è½¬æ¢ï¼‰
                intermediate_transition = self._create_transition(f"t_{source_id}_{target_id}")
                transitions.add(intermediate_transition)
                flow_relation.add((source_place, intermediate_transition))
                flow_relation.add((intermediate_transition, target_place))

        return PetriNet(
            places=places,
            transitions=transitions,
            flow_relation=flow_relation,
            initial_marking=initial_marking
        )

    def _create_place(self, name: str) -> str:
        """åˆ›å»ºåº“æ‰€"""
        place_id = f"p_{self.place_counter}_{name}"
        self.place_counter += 1
        return place_id

    def _create_transition(self, name: str) -> str:
        """åˆ›å»ºå˜è¿"""
        transition_id = f"t_{self.transition_counter}_{name}"
        self.transition_counter += 1
        return transition_id
```

---

## 6. åº”ç”¨æ¡ˆä¾‹ / Application Cases

### 6.1 PLCç¨‹åºéªŒè¯ / PLC Program Verification

**æ¡ˆä¾‹æè¿°**ï¼šå°†PLCçš„SFCç¨‹åºè½¬æ¢ä¸ºPetriç½‘è¿›è¡Œå½¢å¼åŒ–éªŒè¯ã€‚

**ä¼˜åŠ¿**ï¼š

- å¯ä»¥ä½¿ç”¨Petriç½‘åˆ†æå·¥å…·
- å¯ä»¥è¿›è¡Œæ­»é”æ£€æµ‹
- å¯ä»¥éªŒè¯ç¨‹åºæ­£ç¡®æ€§

### 6.2 å·¥ä¸šæ§åˆ¶ç³»ç»Ÿå»ºæ¨¡ / Industrial Control System Modeling

**æ¡ˆä¾‹æè¿°**ï¼šä½¿ç”¨SFCå»ºæ¨¡å·¥ä¸šæ§åˆ¶ç³»ç»Ÿï¼Œè½¬æ¢ä¸ºPetriç½‘è¿›è¡Œåˆ†æã€‚

**åˆ†æå†…å®¹**ï¼š

- ç³»ç»Ÿå¯è¾¾æ€§åˆ†æ
- å¹¶å‘æ€§åˆ†æ
- èµ„æºç«äº‰åˆ†æ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: GraphNetWorkCommunicateé¡¹ç›®ç»„
