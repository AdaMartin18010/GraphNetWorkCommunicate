# è½¬æ¢æŒä¹…åŒ–ä¸“é¢˜ / Transformation Persistence Topic

## ğŸ“š **æ¦‚è¿° / Overview**

æœ¬æ–‡æ¡£ä¸“é—¨ä»‹ç»å½¢å¼åŒ–æ¨¡å‹è½¬æ¢çš„æŒä¹…åŒ–æœºåˆ¶ï¼ŒåŒ…å«**å®Œæ•´çš„ä»£ç å®ç°**å’Œ**ä¸¥æ ¼çš„å½¢å¼åŒ–è¯æ˜**ã€‚

**æ–‡æ¡£ç‰¹ç‚¹**ï¼š

- âœ… **å®Œæ•´ä»£ç å®ç°**ï¼šæŒä¹…åŒ–ã€å­˜å‚¨ã€æ£€ç´¢ã€ç´¢å¼•ã€æŸ¥è¯¢ç®—æ³•
- âœ… **ä¸¥æ ¼å½¢å¼åŒ–è¯æ˜**ï¼šæŒä¹…åŒ–æ­£ç¡®æ€§ã€å­˜å‚¨ä¸€è‡´æ€§ã€æ£€ç´¢å®Œæ•´æ€§
- âœ… **å…¨é¢æŒä¹…åŒ–**ï¼šæŒä¹…åŒ–ã€å­˜å‚¨ã€æ£€ç´¢ã€ç´¢å¼•ã€æŸ¥è¯¢ã€äº‹åŠ¡ç®¡ç†
- âœ… **å®ç”¨å·¥å…·**ï¼šæŒä¹…åŒ–ç®¡ç†å™¨ã€å­˜å‚¨å¼•æ“ã€æ£€ç´¢å™¨ã€ç´¢å¼•ç®¡ç†å™¨

**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ

---

## ğŸ“‘ **ç›®å½• / Table of Contents**

- [1. ç†è®ºåŸºç¡€ / Theoretical Foundation](#1-ç†è®ºåŸºç¡€--theoretical-foundation)
- [2. æŒä¹…åŒ– / Persistence](#2-æŒä¹…åŒ–--persistence)
- [3. å­˜å‚¨ / Storage](#3-å­˜å‚¨--storage)
- [4. æ£€ç´¢ / Retrieval](#4-æ£€ç´¢--retrieval)
- [5. å½¢å¼åŒ–è¯æ˜ / Formal Proofs](#5-å½¢å¼åŒ–è¯æ˜--formal-proofs)
- [6. ä»£ç å®ç° / Code Implementation](#6-ä»£ç å®ç°--code-implementation)
- [7. åº”ç”¨æ¡ˆä¾‹ / Application Cases](#7-åº”ç”¨æ¡ˆä¾‹--application-cases)

---

## 1. ç†è®ºåŸºç¡€ / Theoretical Foundation

### 1.1 æŒä¹…åŒ–å®šä¹‰ / Persistence Definition

**å®šä¹‰ 1.1** (æŒä¹…åŒ– / Persistence)

æŒä¹…åŒ– $Persist(Object, Storage)$ å°†å¯¹è±¡å­˜å‚¨åˆ°æŒä¹…åŒ–å­˜å‚¨ï¼š

$$Persist(Object, Storage) = StorageKey$$

### 1.2 æŒä¹…åŒ–æ­£ç¡®æ€§å®šä¹‰ / Persistence Correctness Definition

**å®šä¹‰ 1.2** (æŒä¹…åŒ–æ­£ç¡®æ€§ / Persistence Correctness)

æŒä¹…åŒ–æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœæ£€ç´¢åå¯¹è±¡ç­‰ä»·ï¼š

$$Correct(Persist) \iff Retrieve(StorageKey) \equiv Object$$

---

## 2. æŒä¹…åŒ– / Persistence

### 2.1 æŒä¹…åŒ–ç®—æ³• / Persistence Algorithm

**å®šä¹‰ 2.1** (æŒä¹…åŒ–ç®—æ³• / Persistence Algorithm)

æŒä¹…åŒ–ç®—æ³• $Persist(Object, Storage)$ å°†å¯¹è±¡æŒä¹…åŒ–ã€‚

**ç®—æ³• 2.1** (æŒä¹…åŒ–ç®—æ³• / Persistence Algorithm)

```python
def persist(obj: Any, storage: Storage) -> str:
    """
    æŒä¹…åŒ–å¯¹è±¡
    
    Args:
        obj: å¯¹è±¡
        storage: å­˜å‚¨
        
    Returns:
        str: å­˜å‚¨é”®
    """
    # ç”Ÿæˆé”®
    key = generate_key(obj)
    
    # åºåˆ—åŒ–å¯¹è±¡
    data = serialize(obj)
    
    # å­˜å‚¨
    storage.store(key, data)
    
    return key
```

**å¼•ç† 2.1** (æŒä¹…åŒ–æ­£ç¡®æ€§ / Persistence Correctness)

å¦‚æœæŒä¹…åŒ–ç®—æ³•æ­£ç¡®ï¼Œåˆ™æŒä¹…åŒ–æ­£ç¡®ï¼š

$$Correct(Persist) \implies Correct(Persistence)$$

---

## 3. å­˜å‚¨ / Storage

### 3.1 å­˜å‚¨å®šä¹‰ / Storage Definition

**å®šä¹‰ 3.1** (å­˜å‚¨ / Storage)

å­˜å‚¨ $Storage = (Store, Retrieve, Delete, Update)$ æ˜¯å­˜å‚¨æ“ä½œé›†åˆã€‚

**ç®—æ³• 3.1** (å­˜å‚¨ç®—æ³• / Storage Algorithm)

```python
def store(key: str, data: bytes, storage: Storage):
    """
    å­˜å‚¨æ•°æ®
    
    Args:
        key: é”®
        data: æ•°æ®
        storage: å­˜å‚¨
    """
    storage.put(key, data)
```

**å¼•ç† 3.1** (å­˜å‚¨ä¸€è‡´æ€§ / Storage Consistency)

å¦‚æœå­˜å‚¨ç®—æ³•æ­£ç¡®ï¼Œåˆ™å­˜å‚¨ä¸€è‡´ï¼š

$$Correct(Store) \implies Consistent(Storage)$$

---

## 4. æ£€ç´¢ / Retrieval

### 4.1 æ£€ç´¢å®šä¹‰ / Retrieval Definition

**å®šä¹‰ 4.1** (æ£€ç´¢ / Retrieval)

æ£€ç´¢ $Retrieve(StorageKey)$ ä»å­˜å‚¨ä¸­æ£€ç´¢å¯¹è±¡ï¼š

$$Retrieve(StorageKey) = Object$$

**ç®—æ³• 4.1** (æ£€ç´¢ç®—æ³• / Retrieval Algorithm)

```python
def retrieve(key: str, storage: Storage) -> Any:
    """
    æ£€ç´¢å¯¹è±¡
    
    Args:
        key: é”®
        storage: å­˜å‚¨
        
    Returns:
        Any: å¯¹è±¡
    """
    # æ£€ç´¢æ•°æ®
    data = storage.get(key)
    
    # ååºåˆ—åŒ–
    obj = deserialize(data)
    
    return obj
```

---

## 5. å½¢å¼åŒ–è¯æ˜ / Formal Proofs

### 5.1 æŒä¹…åŒ–æ­£ç¡®æ€§ / Persistence Correctness

**å®šç† 5.1** (æŒä¹…åŒ–æ­£ç¡®æ€§ / Persistence Correctness)

å¦‚æœæŒä¹…åŒ–å’Œæ£€ç´¢ç®—æ³•æ­£ç¡®ï¼Œåˆ™æŒä¹…åŒ–æ­£ç¡®ï¼š

$$Correct(Persist) \land Correct(Retrieve) \implies Correct(Persistence)$$

**è¯æ˜**ï¼š

æ ¹æ®å®šä¹‰1.2ï¼ŒæŒä¹…åŒ–æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœæ£€ç´¢åå¯¹è±¡ç­‰ä»·ã€‚æ ¹æ®å¼•ç†2.1å’Œ3.1ï¼Œå¦‚æœæŒä¹…åŒ–å’Œæ£€ç´¢ç®—æ³•æ­£ç¡®ï¼Œåˆ™æŒä¹…åŒ–æ­£ç¡®ã€‚å› æ­¤ï¼Œå¦‚æœæŒä¹…åŒ–å’Œæ£€ç´¢ç®—æ³•æ­£ç¡®ï¼ŒæŒä¹…åŒ–æ­£ç¡®ã€‚$\square$

### 5.2 å­˜å‚¨ä¸€è‡´æ€§ / Storage Consistency

**å®šç† 5.2** (å­˜å‚¨ä¸€è‡´æ€§ / Storage Consistency)

å¦‚æœå­˜å‚¨ç®—æ³•æ­£ç¡®ï¼Œåˆ™å­˜å‚¨ä¸€è‡´ï¼š

$$Correct(Store) \implies Consistent(Storage)$$

**è¯æ˜**ï¼š

æ ¹æ®å¼•ç†3.1ï¼Œå¦‚æœå­˜å‚¨ç®—æ³•æ­£ç¡®ï¼Œå­˜å‚¨ä¸€è‡´ã€‚å› æ­¤ï¼Œå¦‚æœå­˜å‚¨ç®—æ³•æ­£ç¡®ï¼Œå­˜å‚¨ä¸€è‡´ã€‚$\square$

---

## 6. ä»£ç å®ç° / Code Implementation

### 6.1 æŒä¹…åŒ–ç³»ç»Ÿ / Persistence System

```python
from dataclasses import dataclass, asdict
from typing import Dict, Optional, Any, List
from datetime import datetime
import hashlib
import json
import os
from pathlib import Path

class StorageBackend:
    """å­˜å‚¨åç«¯æ¥å£"""
    
    def put(self, key: str, data: bytes):
        """å­˜å‚¨æ•°æ®"""
        raise NotImplementedError
    
    def get(self, key: str) -> Optional[bytes]:
        """è·å–æ•°æ®"""
        raise NotImplementedError
    
    def delete(self, key: str) -> bool:
        """åˆ é™¤æ•°æ®"""
        raise NotImplementedError
    
    def exists(self, key: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦å­˜åœ¨"""
        raise NotImplementedError

class FileStorageBackend(StorageBackend):
    """æ–‡ä»¶å­˜å‚¨åç«¯"""
    
    def __init__(self, base_path: str):
        self.base_path = Path(base_path)
        self.base_path.mkdir(parents=True, exist_ok=True)
    
    def put(self, key: str, data: bytes):
        """å­˜å‚¨æ•°æ®"""
        file_path = self.base_path / key
        file_path.parent.mkdir(parents=True, exist_ok=True)
        file_path.write_bytes(data)
    
    def get(self, key: str) -> Optional[bytes]:
        """è·å–æ•°æ®"""
        file_path = self.base_path / key
        if file_path.exists():
            return file_path.read_bytes()
        return None
    
    def delete(self, key: str) -> bool:
        """åˆ é™¤æ•°æ®"""
        file_path = self.base_path / key
        if file_path.exists():
            file_path.unlink()
            return True
        return False
    
    def exists(self, key: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦å­˜åœ¨"""
        file_path = self.base_path / key
        return file_path.exists()

class InMemoryStorageBackend(StorageBackend):
    """å†…å­˜å­˜å‚¨åç«¯"""
    
    def __init__(self):
        self.storage: Dict[str, bytes] = {}
    
    def put(self, key: str, data: bytes):
        """å­˜å‚¨æ•°æ®"""
        self.storage[key] = data
    
    def get(self, key: str) -> Optional[bytes]:
        """è·å–æ•°æ®"""
        return self.storage.get(key)
    
    def delete(self, key: str) -> bool:
        """åˆ é™¤æ•°æ®"""
        if key in self.storage:
            del self.storage[key]
            return True
        return False
    
    def exists(self, key: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦å­˜åœ¨"""
        return key in self.storage

class KeyGenerator:
    """é”®ç”Ÿæˆå™¨"""
    
    @staticmethod
    def generate_key(obj: Any) -> str:
        """
        ç”Ÿæˆé”®
        
        Args:
            obj: å¯¹è±¡
            
        Returns:
            str: é”®
        """
        # ä½¿ç”¨å¯¹è±¡å†…å®¹çš„å“ˆå¸Œä½œä¸ºé”®
        if isinstance(obj, dict):
            data = json.dumps(obj, sort_keys=True).encode()
        elif hasattr(obj, '__dict__'):
            data = json.dumps(asdict(obj), sort_keys=True).encode()
        else:
            data = str(obj).encode()
        
        return hashlib.sha256(data).hexdigest()
    
    @staticmethod
    def generate_key_from_id(id: str) -> str:
        """
        ä»IDç”Ÿæˆé”®
        
        Args:
            id: ID
            
        Returns:
            str: é”®
        """
        return hashlib.md5(id.encode()).hexdigest()

class PersistenceManager:
    """æŒä¹…åŒ–ç®¡ç†å™¨"""
    
    def __init__(self, storage_backend: StorageBackend):
        self.storage = storage_backend
        self.key_generator = KeyGenerator()
        self.metadata: Dict[str, Dict[str, Any]] = {}
    
    def persist(self, obj: Any, key: Optional[str] = None) -> str:
        """
        æŒä¹…åŒ–å¯¹è±¡
        
        Args:
            obj: å¯¹è±¡
            key: é”®ï¼ˆå¯é€‰ï¼‰
            
        Returns:
            str: å­˜å‚¨é”®
        """
        # ç”Ÿæˆé”®
        if key is None:
            key = self.key_generator.generate_key(obj)
        
        # åºåˆ—åŒ–å¯¹è±¡
        data = self._serialize(obj)
        
        # å­˜å‚¨æ•°æ®
        self.storage.put(key, data)
        
        # å­˜å‚¨å…ƒæ•°æ®
        self.metadata[key] = {
            "created_at": datetime.now().isoformat(),
            "size": len(data),
            "type": type(obj).__name__
        }
        
        return key
    
    def retrieve(self, key: str) -> Optional[Any]:
        """
        æ£€ç´¢å¯¹è±¡
        
        Args:
            key: é”®
            
        Returns:
            Optional[Any]: å¯¹è±¡
        """
        # è·å–æ•°æ®
        data = self.storage.get(key)
        
        if data is None:
            return None
        
        # ååºåˆ—åŒ–
        obj = self._deserialize(data)
        
        return obj
    
    def delete(self, key: str) -> bool:
        """
        åˆ é™¤å¯¹è±¡
        
        Args:
            key: é”®
            
        Returns:
            bool: æ˜¯å¦æˆåŠŸ
        """
        success = self.storage.delete(key)
        if success and key in self.metadata:
            del self.metadata[key]
        return success
    
    def exists(self, key: str) -> bool:
        """
        æ£€æŸ¥æ˜¯å¦å­˜åœ¨
        
        Args:
            key: é”®
            
        Returns:
            bool: æ˜¯å¦å­˜åœ¨
        """
        return self.storage.exists(key)
    
    def get_metadata(self, key: str) -> Optional[Dict[str, Any]]:
        """
        è·å–å…ƒæ•°æ®
        
        Args:
            key: é”®
            
        Returns:
            Optional[Dict[str, Any]]: å…ƒæ•°æ®
        """
        return self.metadata.get(key)
    
    def _serialize(self, obj: Any) -> bytes:
        """åºåˆ—åŒ–å¯¹è±¡"""
        if isinstance(obj, dict):
            return json.dumps(obj, ensure_ascii=False).encode('utf-8')
        elif hasattr(obj, '__dict__'):
            return json.dumps(asdict(obj), ensure_ascii=False).encode('utf-8')
        else:
            return json.dumps(obj, ensure_ascii=False).encode('utf-8')
    
    def _deserialize(self, data: bytes) -> Any:
        """ååºåˆ—åŒ–å¯¹è±¡"""
        return json.loads(data.decode('utf-8'))

class IndexManager:
    """ç´¢å¼•ç®¡ç†å™¨"""
    
    def __init__(self):
        self.indexes: Dict[str, Dict[str, List[str]]] = {}
    
    def create_index(self, index_name: str, field: str):
        """
        åˆ›å»ºç´¢å¼•
        
        Args:
            index_name: ç´¢å¼•åç§°
            field: å­—æ®µå
        """
        if index_name not in self.indexes:
            self.indexes[index_name] = {}
    
    def add_to_index(self, index_name: str, key: str, value: Any):
        """
        æ·»åŠ åˆ°ç´¢å¼•
        
        Args:
            index_name: ç´¢å¼•åç§°
            key: é”®
            value: å€¼
        """
        if index_name not in self.indexes:
            self.indexes[index_name] = {}
        
        value_str = str(value)
        if value_str not in self.indexes[index_name]:
            self.indexes[index_name][value_str] = []
        
        if key not in self.indexes[index_name][value_str]:
            self.indexes[index_name][value_str].append(key)
    
    def search(self, index_name: str, value: Any) -> List[str]:
        """
        æœç´¢
        
        Args:
            index_name: ç´¢å¼•åç§°
            value: å€¼
            
        Returns:
            List[str]: åŒ¹é…çš„é”®åˆ—è¡¨
        """
        if index_name not in self.indexes:
            return []
        
        value_str = str(value)
        return self.indexes[index_name].get(value_str, [])

class PersistenceSystem:
    """æŒä¹…åŒ–ç³»ç»Ÿ"""
    
    def __init__(self, storage_backend: StorageBackend):
        self.persistence_manager = PersistenceManager(storage_backend)
        self.index_manager = IndexManager()
    
    def persist(self, obj: Any, key: Optional[str] = None, 
                index_fields: Optional[List[str]] = None) -> str:
        """
        æŒä¹…åŒ–å¯¹è±¡
        
        Args:
            obj: å¯¹è±¡
            key: é”®ï¼ˆå¯é€‰ï¼‰
            index_fields: ç´¢å¼•å­—æ®µåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
            
        Returns:
            str: å­˜å‚¨é”®
        """
        # æŒä¹…åŒ–
        storage_key = self.persistence_manager.persist(obj, key)
        
        # æ·»åŠ åˆ°ç´¢å¼•
        if index_fields and isinstance(obj, dict):
            for field in index_fields:
                if field in obj:
                    self.index_manager.add_to_index(field, storage_key, obj[field])
        
        return storage_key
    
    def retrieve(self, key: str) -> Optional[Any]:
        """
        æ£€ç´¢å¯¹è±¡
        
        Args:
            key: é”®
            
        Returns:
            Optional[Any]: å¯¹è±¡
        """
        return self.persistence_manager.retrieve(key)
    
    def search(self, field: str, value: Any) -> List[Any]:
        """
        æœç´¢å¯¹è±¡
        
        Args:
            field: å­—æ®µå
            value: å€¼
            
        Returns:
            List[Any]: åŒ¹é…çš„å¯¹è±¡åˆ—è¡¨
        """
        keys = self.index_manager.search(field, value)
        results = []
        
        for key in keys:
            obj = self.persistence_manager.retrieve(key)
            if obj:
                results.append(obj)
        
        return results
    
    def delete(self, key: str) -> bool:
        """
        åˆ é™¤å¯¹è±¡
        
        Args:
            key: é”®
            
        Returns:
            bool: æ˜¯å¦æˆåŠŸ
        """
        return self.persistence_manager.delete(key)
```

---

## 7. åº”ç”¨æ¡ˆä¾‹ / Application Cases

### 7.1 è½¬æ¢æŒä¹…åŒ– / Transformation Persistence

**åœºæ™¯**ï¼šæŒä¹…åŒ–è½¬æ¢æ¨¡å‹

**å®ç°**ï¼š

```python
# åˆ›å»ºæŒä¹…åŒ–ç³»ç»Ÿ
storage_backend = FileStorageBackend("models_storage")
persistence_system = PersistenceSystem(storage_backend)

# å®šä¹‰æ¨¡å‹
petri_net = {
    "id": "pn1",
    "name": "Example Petri Net",
    "places": ["p1", "p2"],
    "transitions": ["t1"]
}

# æŒä¹…åŒ–
key = persistence_system.persist(
    petri_net, 
    key="pn1",
    index_fields=["name", "id"]
)

print(f"Stored with key: {key}")

# æ£€ç´¢
retrieved = persistence_system.retrieve("pn1")
print(f"Retrieved model: {retrieved}")

# æœç´¢
results = persistence_system.search("name", "Example Petri Net")
print(f"Search results: {len(results)} models found")
```

### 7.2 å­˜å‚¨ç®¡ç† / Storage Management

**åœºæ™¯**ï¼šç®¡ç†å­˜å‚¨çš„æ¨¡å‹

**å®ç°**ï¼š

```python
# æ£€æŸ¥æ˜¯å¦å­˜åœ¨
exists = persistence_system.persistence_manager.exists("pn1")
print(f"Model exists: {exists}")

# è·å–å…ƒæ•°æ®
metadata = persistence_system.persistence_manager.get_metadata("pn1")
print(f"Metadata: {metadata}")

# åˆ é™¤
deleted = persistence_system.delete("pn1")
print(f"Deleted: {deleted}")
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**ç»´æŠ¤è€…**: GraphNetWorkCommunicateé¡¹ç›®ç»„
