# åŒºå—é“¾åº”ç”¨æ¨¡å¼å®ç°æŒ‡å— / Blockchain Application Patterns Implementation Guide

## ğŸ“š **æ¦‚è¿° / Overview**

**æ–‡æ¡£ç›®çš„**: æä¾›åŒºå—é“¾é¢†åŸŸåº”ç”¨æ¨¡å¼çš„è¯¦ç»†å®ç°æŒ‡å—ï¼ŒåŒ…æ‹¬å·¥å…·é…ç½®ã€ä»£ç ç¤ºä¾‹ã€æœ€ä½³å®è·µã€‚

**é€‚ç”¨å¯¹è±¡**: åŒºå—é“¾æ¶æ„å¸ˆã€æ™ºèƒ½åˆçº¦å¼€å‘è€…ã€å®‰å…¨ç ”ç©¶äººå‘˜

---

## ğŸ¯ **ä¸€ã€ç¯å¢ƒå‡†å¤‡ / Part 1: Environment Setup**

### 1.1 å½¢å¼åŒ–éªŒè¯å·¥å…·å®‰è£…

#### TLA+

**å®‰è£…æ­¥éª¤**:

1. ä¸‹è½½TLA+ Toolboxï¼š<https://github.com/tlaplus/tlaplus/releases>
2. å®‰è£…Javaè¿è¡Œç¯å¢ƒï¼ˆJRE 11+ï¼‰
3. å¯åŠ¨TLA+ Toolbox

**é…ç½®è¦ç‚¹**:

```bash
export TLA_PATH=/path/to/tlaplus
export JAVA_HOME=/path/to/java
```

#### CPN Tools

**å®‰è£…æ­¥éª¤**:

1. ä¸‹è½½CPN Toolsï¼š<http://cpntools.org/download>
2. å®‰è£…Javaè¿è¡Œç¯å¢ƒ
3. å¯åŠ¨CPN Tools

### 1.2 æ™ºèƒ½åˆçº¦å¼€å‘å·¥å…·

#### Solidity + Hardhat

**å®‰è£…æ­¥éª¤**:

```bash
npm install --save-dev hardhat
npm install --save-dev @nomicfoundation/hardhat-toolbox
```

### 1.3 å®‰å…¨åˆ†æå·¥å…·

#### Mythril

**å®‰è£…æ­¥éª¤**:

```bash
pip install mythril
```

#### Slither

**å®‰è£…æ­¥éª¤**:

```bash
pip install slither-analyzer
```

---

## ğŸ”§ **äºŒã€æ™ºèƒ½åˆçº¦å½¢å¼åŒ–éªŒè¯å®ç° / Part 2: Smart Contract Formal Verification Implementation**

### 2.1 TLA+è§„èŒƒç¼–å†™

**å®Œæ•´TLA+è§„èŒƒ**:

```tla
EXTENDS Naturals, TLC

CONSTANTS TotalBalance, UserABalance, TransferAmount

VARIABLES
    contractBalance,
    userABalance,
    userBBalance,
    transferRequest,
    externalCall,
    reentrancyFlag,
    operationComplete

TypeOK ==
    /\ contractBalance \in 0..TotalBalance
    /\ userABalance \in 0..TotalBalance
    /\ userBBalance \in 0..TotalBalance
    /\ transferRequest \in {TRUE, FALSE}
    /\ externalCall \in {TRUE, FALSE}
    /\ reentrancyFlag \in 0..1
    /\ operationComplete \in {TRUE, FALSE}
    /\ contractBalance + userABalance + userBBalance = TotalBalance

Init ==
    /\ contractBalance = TotalBalance - UserABalance
    /\ userABalance = UserABalance
    /\ userBBalance = 0
    /\ transferRequest = FALSE
    /\ externalCall = FALSE
    /\ reentrancyFlag = 0
    /\ operationComplete = FALSE

InitiateTransfer ==
    /\ transferRequest = FALSE
    /\ userABalance >= TransferAmount
    /\ transferRequest' = TRUE
    /\ reentrancyFlag' = 0
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   externalCall, operationComplete>>

ExecuteTransfer ==
    /\ transferRequest = TRUE
    /\ reentrancyFlag = 0
    /\ contractBalance >= TransferAmount
    /\ contractBalance' = contractBalance - TransferAmount
    /\ userBBalance' = userBBalance + TransferAmount
    /\ externalCall' = TRUE
    /\ UNCHANGED <<userABalance, transferRequest, reentrancyFlag, operationComplete>>

ExternalCall ==
    /\ externalCall = TRUE
    /\ reentrancyFlag' = reentrancyFlag + 1
    /\ externalCall' = FALSE
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   transferRequest, operationComplete>>

ReentrancyCheck ==
    /\ reentrancyFlag > 0
    /\ transferRequest = TRUE
    /\ reentrancyFlag' = reentrancyFlag - 1
    /\ transferRequest' = FALSE
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   externalCall, operationComplete>>

CompleteOperation ==
    /\ externalCall = FALSE
    /\ reentrancyFlag = 0
    /\ transferRequest = TRUE
    /\ transferRequest' = FALSE
    /\ operationComplete' = TRUE
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   externalCall, reentrancyFlag>>

Next ==
    \/ InitiateTransfer
    \/ ExecuteTransfer
    \/ ExternalCall
    \/ ReentrancyCheck
    \/ CompleteOperation

Spec == Init /\ [][Next]_<<contractBalance, userABalance, userBBalance,
                      transferRequest, externalCall, reentrancyFlag, operationComplete>>

BalanceInvariant ==
    \A s \in ReachableStates :
        contractBalance + userABalance + userBBalance = TotalBalance

ReentrancySafe ==
    \A s \in ReachableStates :
        reentrancyFlag <= 1
```

### 2.2 Solidityå®‰å…¨åˆçº¦å®ç°

**å®‰å…¨åˆçº¦ç¤ºä¾‹**:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SecureTransfer {
    mapping(address => uint256) private balances;
    bool private locked;

    modifier nonReentrant() {
        require(!locked, "ReentrancyGuard: reentrant call");
        locked = true;
        _;
        locked = false;
    }

    function deposit() public payable {
        balances[msg.sender] += msg.value;
    }

    function withdraw(uint256 amount) public nonReentrant {
        require(balances[msg.sender] >= amount, "Insufficient balance");

        balances[msg.sender] -= amount;
        (bool success, ) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }

    function getBalance(address account) public view returns (uint256) {
        return balances[account];
    }
}
```

---

## ğŸ“Š **ä¸‰ã€å®‰å…¨åˆ†æå®ç° / Part 3: Security Analysis Implementation**

### 3.1 Mythrilåˆ†æ

**ä½¿ç”¨Mythril**:

```bash
mythril analyze contract.sol
```

**Pythonè„šæœ¬**:

```python
from mythril.mythril import MythrilAnalyzer
from mythril.analysis.security import VulnerabilityType

class SecurityAnalyzer:
    def __init__(self):
        self.analyzer = MythrilAnalyzer()

    def analyze_contract(self, contract_path):
        """
        åˆ†ææ™ºèƒ½åˆçº¦
        """
        results = self.analyzer.analyze(contract_path)

        vulnerabilities = []
        for result in results:
            if result.vulnerability_type in [
                VulnerabilityType.REENTRANCY,
                VulnerabilityType.INTEGER_OVERFLOW,
                VulnerabilityType.ACCESS_CONTROL
            ]:
                vulnerabilities.append({
                    'type': result.vulnerability_type,
                    'severity': result.severity,
                    'description': result.description,
                    'location': result.location
                })

        return vulnerabilities
```

### 3.2 Slitheråˆ†æ

**ä½¿ç”¨Slither**:

```bash
slither contract.sol
```

**Pythonè„šæœ¬**:

```python
from slither import Slither
from slither.detectors import all_detectors

class SlitherAnalyzer:
    def __init__(self):
        self.slither = None

    def analyze_contract(self, contract_path):
        """
        åˆ†ææ™ºèƒ½åˆçº¦
        """
        self.slither = Slither(contract_path)

        # è¿è¡Œæ‰€æœ‰æ£€æµ‹å™¨
        detectors = all_detectors.get_detectors()

        results = []
        for detector in detectors:
            findings = detector.run(self.slither)
            results.extend(findings)

        return results
```

---

## ğŸ“‹ **å››ã€æœ€ä½³å®è·µ / Part 4: Best Practices**

### 4.1 å®‰å…¨å¼€å‘å®è·µ

1. **é‡å…¥é˜²æŠ¤**: ä½¿ç”¨ReentrancyGuardæ¨¡å¼
2. **æº¢å‡ºé˜²æŠ¤**: ä½¿ç”¨SafeMathåº“
3. **è®¿é—®æ§åˆ¶**: ä½¿ç”¨Role-Based Access Control (RBAC)
4. **äº‹ä»¶è®°å½•**: è®°å½•æ‰€æœ‰é‡è¦æ“ä½œ

### 4.2 éªŒè¯å®è·µ

1. **å½¢å¼åŒ–éªŒè¯**: ä½¿ç”¨TLA+éªŒè¯å…³é”®æ€§è´¨
2. **è‡ªåŠ¨æ£€æµ‹**: ä½¿ç”¨Mythrilå’ŒSlither
3. **ä»£ç å®¡æŸ¥**: è¿›è¡Œè¯¦ç»†çš„å®‰å…¨å®¡æŸ¥
4. **æµ‹è¯•è¦†ç›–**: è¾¾åˆ°100%æµ‹è¯•è¦†ç›–

---

## ğŸ“š **äº”ã€å‚è€ƒæ–‡æ¡£ / Part 5: Reference Documents**

### 5.1 ç›¸å…³æ–‡æ¡£

- [åŒºå—é“¾åº”ç”¨æ¨¡å¼æ¸…å•](./åŒºå—é“¾åº”ç”¨æ¨¡å¼æ¸…å•.md)
- [è¯¦ç»†æ¡ˆä¾‹ï¼šæ™ºèƒ½åˆçº¦å®‰å…¨éªŒè¯](./01-è¯¦ç»†æ¡ˆä¾‹-æ™ºèƒ½åˆçº¦å®‰å…¨éªŒè¯.md)

### 5.2 å·¥å…·æ–‡æ¡£

- [TLA+å­¦ä¹ èµ„æº](https://learntla.com/)
- [Solidityæ–‡æ¡£](https://docs.soliditylang.org/)
- [Mythrilæ–‡æ¡£](https://mythril-classic.readthedocs.io/)
- [Slitheræ–‡æ¡£](https://github.com/crytic/slither)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
**ç»´æŠ¤è€…**: GraphNetWorkCommunicateé¡¹ç›®ç»„
