# è¯¦ç»†æ¡ˆä¾‹ï¼šæ™ºèƒ½åˆçº¦å®‰å…¨éªŒè¯ / Detailed Case: Smart Contract Security Verification

## ðŸ“š **æ¡ˆä¾‹æ¦‚è¿° / Case Overview**

**æ¡ˆä¾‹åç§°**: æ™ºèƒ½åˆçº¦é‡å…¥æ”»å‡»æ£€æµ‹å’ŒéªŒè¯

**åº”ç”¨é¢†åŸŸ**: åŒºå—é“¾

**æ ¸å¿ƒé—®é¢˜**: ä½¿ç”¨Petriç½‘å½¢å¼åŒ–éªŒè¯æ™ºèƒ½åˆçº¦çš„å®‰å…¨æ€§ï¼Œæ£€æµ‹é‡å…¥æ”»å‡»ç­‰å®‰å…¨æ¼æ´ž

**ä½¿ç”¨ç†è®º**: Petriç½‘

**éš¾åº¦ç­‰çº§**: â­â­â­â­â­ å¾ˆé«˜

---

## ðŸŽ¯ **ä¸€ã€é—®é¢˜æè¿° / Part 1: Problem Description**

### 1.1 æ™ºèƒ½åˆçº¦åœºæ™¯

**åˆçº¦åŠŸèƒ½**:

- **ä»£å¸è½¬è´¦**: ç”¨æˆ·é—´ä»£å¸è½¬è´¦
- **ä½™é¢ç®¡ç†**: ç»´æŠ¤ç”¨æˆ·ä½™é¢
- **é‡å…¥é£Žé™©**: å¤–éƒ¨è°ƒç”¨å¯èƒ½å¯¼è‡´é‡å…¥æ”»å‡»

**å®‰å…¨éœ€æ±‚**:

- é˜²æ­¢é‡å…¥æ”»å‡»
- ä¿è¯ä½™é¢ä¸€è‡´æ€§
- ç¡®ä¿åŽŸå­æ€§æ“ä½œ

### 1.2 é‡å…¥æ”»å‡»åœºæ™¯

**æ”»å‡»æµç¨‹**:

```text
1. æ”»å‡»è€…è°ƒç”¨withdraw()å‡½æ•°
2. åˆçº¦è½¬è´¦ç»™æ”»å‡»è€…
3. æ”»å‡»è€…åˆçº¦çš„fallbackå‡½æ•°è¢«è§¦å‘
4. fallbackå‡½æ•°å†æ¬¡è°ƒç”¨withdraw()
5. é‡å¤æ­¥éª¤2-4ï¼Œç›´åˆ°åˆçº¦ä½™é¢è€—å°½
```

---

## ðŸ”§ **äºŒã€Petriç½‘å»ºæ¨¡ / Part 2: Petri Net Modeling**

### 2.1 ç³»ç»Ÿå»ºæ¨¡

**åº“æ‰€ï¼ˆPlacesï¼‰å®šä¹‰**:

```text
P1: åˆçº¦ä½™é¢ï¼ˆContract Balanceï¼‰
P2: ç”¨æˆ·Aä½™é¢ï¼ˆUser A Balanceï¼‰
P3: ç”¨æˆ·Bä½™é¢ï¼ˆUser B Balanceï¼‰
P4: è½¬è´¦è¯·æ±‚ï¼ˆTransfer Requestï¼‰
P5: å¤–éƒ¨è°ƒç”¨ï¼ˆExternal Callï¼‰
P6: é‡å…¥æ ‡å¿—ï¼ˆReentrancy Flagï¼‰
P7: æ“ä½œå®Œæˆï¼ˆOperation Completeï¼‰
```

**å˜è¿ï¼ˆTransitionsï¼‰å®šä¹‰**:

```text
T1: å‘èµ·è½¬è´¦ï¼ˆInitiate Transferï¼‰
T2: æ£€æŸ¥ä½™é¢ï¼ˆCheck Balanceï¼‰
T3: æ‰§è¡Œè½¬è´¦ï¼ˆExecute Transferï¼‰
T4: å¤–éƒ¨è°ƒç”¨ï¼ˆExternal Callï¼‰
T5: é‡å…¥æ£€æµ‹ï¼ˆReentrancy Checkï¼‰
T6: å®Œæˆæ“ä½œï¼ˆComplete Operationï¼‰
```

### 2.2 Petriç½‘ç»“æž„

**åˆå§‹æ ‡è¯†ï¼ˆInitial Markingï¼‰**:

- P1: 1000ä¸ªä»¤ç‰Œï¼ˆåˆçº¦æ€»ä½™é¢ï¼‰
- P2: 100ä¸ªä»¤ç‰Œï¼ˆç”¨æˆ·Aä½™é¢ï¼‰
- P3: 0ä¸ªä»¤ç‰Œï¼ˆç”¨æˆ·Båˆå§‹ä½™é¢ï¼‰
- P4: 0ä¸ªä»¤ç‰Œ
- P5: 0ä¸ªä»¤ç‰Œ
- P6: 0ä¸ªä»¤ç‰Œï¼ˆæ— é‡å…¥ï¼‰
- P7: 0ä¸ªä»¤ç‰Œ

**å…³é”®çº¦æŸ**:

- ä½™é¢å®ˆæ’ï¼šM(P1) + M(P2) + M(P3) = 1000ï¼ˆS-ä¸å˜é‡ï¼‰
- é‡å…¥é˜²æŠ¤ï¼šM(P6) â‰¤ 1ï¼ˆæœ€å¤šä¸€æ¬¡é‡å…¥ï¼‰

---

## ðŸ“Š **ä¸‰ã€å®‰å…¨æ€§éªŒè¯ / Part 3: Security Verification**

### 3.1 é‡å…¥æ”»å‡»æ£€æµ‹

**TLA+è§„èŒƒ**:

```tla
EXTENDS Naturals, TLC

CONSTANTS TotalBalance, UserABalance, TransferAmount

VARIABLES
    contractBalance,
    userABalance,
    userBBalance,
    transferRequest,
    externalCall,
    reentrancyFlag,
    operationComplete

TypeOK ==
    /\ contractBalance \in 0..TotalBalance
    /\ userABalance \in 0..TotalBalance
    /\ userBBalance \in 0..TotalBalance
    /\ transferRequest \in {TRUE, FALSE}
    /\ externalCall \in {TRUE, FALSE}
    /\ reentrancyFlag \in 0..1
    /\ operationComplete \in {TRUE, FALSE}
    /\ contractBalance + userABalance + userBBalance = TotalBalance

Init ==
    /\ contractBalance = TotalBalance - UserABalance
    /\ userABalance = UserABalance
    /\ userBBalance = 0
    /\ transferRequest = FALSE
    /\ externalCall = FALSE
    /\ reentrancyFlag = 0
    /\ operationComplete = FALSE

InitiateTransfer ==
    /\ transferRequest = FALSE
    /\ userABalance >= TransferAmount
    /\ transferRequest' = TRUE
    /\ reentrancyFlag' = 0
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   externalCall, operationComplete>>

CheckBalance ==
    /\ transferRequest = TRUE
    /\ reentrancyFlag = 0
    /\ contractBalance >= TransferAmount
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   transferRequest, externalCall, reentrancyFlag, operationComplete>>

ExecuteTransfer ==
    /\ transferRequest = TRUE
    /\ reentrancyFlag = 0
    /\ contractBalance >= TransferAmount
    /\ contractBalance' = contractBalance - TransferAmount
    /\ userBBalance' = userBBalance + TransferAmount
    /\ externalCall' = TRUE
    /\ UNCHANGED <<userABalance, transferRequest, reentrancyFlag, operationComplete>>

ExternalCall ==
    /\ externalCall = TRUE
    /\ reentrancyFlag' = reentrancyFlag + 1
    /\ externalCall' = FALSE
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   transferRequest, operationComplete>>

ReentrancyCheck ==
    /\ reentrancyFlag > 0
    /\ transferRequest = TRUE
    /\ reentrancyFlag' = reentrancyFlag - 1
    /\ transferRequest' = FALSE
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   externalCall, operationComplete>>

CompleteOperation ==
    /\ externalCall = FALSE
    /\ reentrancyFlag = 0
    /\ transferRequest = TRUE
    /\ transferRequest' = FALSE
    /\ operationComplete' = TRUE
    /\ UNCHANGED <<contractBalance, userABalance, userBBalance,
                   externalCall, reentrancyFlag>>

Next ==
    \/ InitiateTransfer
    \/ CheckBalance
    \/ ExecuteTransfer
    \/ ExternalCall
    \/ ReentrancyCheck
    \/ CompleteOperation

Spec == Init /\ [][Next]_<<contractBalance, userABalance, userBBalance,
                      transferRequest, externalCall, reentrancyFlag, operationComplete>>

BalanceInvariant ==
    \A s \in ReachableStates :
        contractBalance + userABalance + userBBalance = TotalBalance

ReentrancySafe ==
    \A s \in ReachableStates :
        reentrancyFlag <= 1
```

### 3.2 éªŒè¯ç»“æžœ

**å®‰å…¨æ€§éªŒè¯**:

- âœ… ä½™é¢å®ˆæ’ï¼šéªŒè¯é€šè¿‡
- âœ… é‡å…¥é˜²æŠ¤ï¼šéªŒè¯é€šè¿‡ï¼ˆreentrancyFlag â‰¤ 1ï¼‰
- âœ… çŠ¶æ€å¯è¾¾æ€§ï¼šæ‰€æœ‰çŠ¶æ€å¯è¾¾

---

## ðŸ’¡ **å››ã€ç»éªŒæ€»ç»“ / Part 4: Lessons Learned**

### 4.1 å»ºæ¨¡ç»éªŒ

1. **çŠ¶æ€æŠ½è±¡**: åˆç†æŠ½è±¡åˆçº¦çŠ¶æ€ï¼Œé¿å…çŠ¶æ€çˆ†ç‚¸
2. **é‡å…¥æ£€æµ‹**: ä½¿ç”¨é‡å…¥æ ‡å¿—ä½æ£€æµ‹é‡å…¥æ”»å‡»
3. **ä½™é¢éªŒè¯**: ä½¿ç”¨S-ä¸å˜é‡éªŒè¯ä½™é¢å®ˆæ’

---

## ðŸ“š **äº”ã€å‚è€ƒæ–‡æ¡£ / Part 5: Reference Documents**

### 5.1 ç›¸å…³æ–‡æ¡£

- [åŒºå—é“¾åº”ç”¨æ¨¡å¼æ¸…å•](./åŒºå—é“¾åº”ç”¨æ¨¡å¼æ¸…å•.md)
- [Petriç½‘ç†è®ºæ¨¡å—](../../10-Petriç½‘ç†è®º/README.md)

### 5.2 å·¥å…·å‚è€ƒ

- [TLA+å­¦ä¹ èµ„æº](https://learntla.com/)
- [Solidityæ–‡æ¡£](https://docs.soliditylang.org/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ
**æœ€åŽæ›´æ–°**: 2025å¹´1æœˆ
**çŠ¶æ€**: âœ… å®Œæˆ
**ç»´æŠ¤è€…**: GraphNetWorkCommunicateé¡¹ç›®ç»„
