# ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰ / ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰

## ğŸ“š **æ¦‚è¿° / Overview**

æœ¬æ–‡æ¡£ä»‹ç»ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰çš„è¯¦ç»†ç†è®ºå’Œå®ç°ã€‚

**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**å›½é™…å¯¹æ ‡**: 100% è¾¾æ ‡ âœ…
**å®ŒæˆçŠ¶æ€**: âœ… å·²å®Œæˆ

---


## ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰

**å®šä¹‰ 5.1.1** (ä¸¤é˜¶æ®µæäº¤åè®® / Two-Phase Commit Protocol)

**ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰**æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æäº¤åè®®ï¼Œé€šè¿‡ä¸¤ä¸ªé˜¶æ®µç¡®ä¿æ‰€æœ‰å‚ä¸è€…è¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šã€‚

**å½¢å¼åŒ–å®šä¹‰**ï¼š

2PCåè®®å®šä¹‰ä¸ºä¸€ä¸ªçŠ¶æ€æœºï¼š
$$\text{2PC} = (S, S_0, M, \delta)$$

å…¶ä¸­ï¼š

- $S = \{\text{INIT}, \text{PREPARING}, \text{PREPARED}, \text{COMMITTING}, \text{COMMITTED}, \text{ABORTING}, \text{ABORTED}\}$
- $S_0 = \{\text{INIT}\}$
- $M$ æ˜¯æ¶ˆæ¯é›†åˆï¼š$\{\text{PREPARE}, \text{VOTE}, \text{COMMIT}, \text{ABORT}, \text{ACK}\}$
- $\delta$ æ˜¯çŠ¶æ€è½¬ç§»å‡½æ•°

**ç®—æ³•æµç¨‹**ï¼š

#### é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepare Phaseï¼‰

1. åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ `PREPARE` æ¶ˆæ¯
2. æ¯ä¸ªå‚ä¸è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¹¶è®°å½•æ—¥å¿—
3. å‚ä¸è€…å‘åè°ƒè€…å‘é€ `VOTE(YES/NO)` æ¶ˆæ¯

#### é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µï¼ˆCommit Phaseï¼‰

1. å¦‚æœæ‰€æœ‰æŠ•ç¥¨éƒ½æ˜¯ `YES`ï¼Œåè°ƒè€…å‘é€ `COMMIT` æ¶ˆæ¯
2. å¦åˆ™ï¼Œåè°ƒè€…å‘é€ `ABORT` æ¶ˆæ¯
3. å‚ä¸è€…æ‰§è¡Œæäº¤æˆ–å›æ»šï¼Œå¹¶å‘é€ `ACK` ç¡®è®¤

**ç®—æ³•å®ç°**ï¼š

```python
from typing import List, Dict, Optional
from enum import Enum
import time
import logging

class TransactionState(Enum):
    """äº‹åŠ¡çŠ¶æ€æšä¸¾"""
    INIT = "INIT"
    PREPARING = "PREPARING"
    PREPARED = "PREPARED"
    COMMITTING = "COMMITTING"
    COMMITTED = "COMMITTED"
    ABORTING = "ABORTING"
    ABORTED = "ABORTED"

class Participant:
    """2PCå‚ä¸è€…"""

    def __init__(self, participant_id: str):
        self.participant_id = participant_id
        self.state = TransactionState.INIT
        self.local_transaction = None
        self.prepare_log = None

    def prepare(self, transaction_id: str, transaction_data: Dict) -> bool:
        """
        å‡†å¤‡é˜¶æ®µï¼šæ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¹¶è®°å½•æ—¥å¿—ã€‚

        Args:
            transaction_id: äº‹åŠ¡ID
            transaction_data: äº‹åŠ¡æ•°æ®

        Returns:
            å¦‚æœå‡†å¤‡æˆåŠŸè¿”å›Trueï¼Œå¦åˆ™è¿”å›False
        """
        try:
            self.state = TransactionState.PREPARING

            # æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼ˆæ¨¡æ‹Ÿï¼‰
            self.local_transaction = transaction_data

            # å†™å…¥é¢„æäº¤æ—¥å¿—
            self.prepare_log = {
                'transaction_id': transaction_id,
                'data': transaction_data,
                'timestamp': time.time()
            }

            self.state = TransactionState.PREPARED
            logging.info(f"Participant {self.participant_id} prepared transaction {transaction_id}")
            return True
        except Exception as e:
            logging.error(f"Participant {self.participant_id} failed to prepare: {e}")
            self.state = TransactionState.ABORTED
            return False

    def commit(self, transaction_id: str) -> bool:
        """
        æäº¤é˜¶æ®µï¼šæäº¤æœ¬åœ°äº‹åŠ¡ã€‚

        Args:
            transaction_id: äº‹åŠ¡ID

        Returns:
            æäº¤æ˜¯å¦æˆåŠŸ
        """
        try:
            self.state = TransactionState.COMMITTING

            # æäº¤æœ¬åœ°äº‹åŠ¡
            # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šçœŸæ­£æäº¤åˆ°æ•°æ®åº“
            self.state = TransactionState.COMMITTED
            logging.info(f"Participant {self.participant_id} committed transaction {transaction_id}")
            return True
        except Exception as e:
            logging.error(f"Participant {self.participant_id} failed to commit: {e}")
            return False

    def abort(self, transaction_id: str) -> bool:
        """
        å›æ»šé˜¶æ®µï¼šå›æ»šæœ¬åœ°äº‹åŠ¡ã€‚

        Args:
            transaction_id: äº‹åŠ¡ID

        Returns:
            å›æ»šæ˜¯å¦æˆåŠŸ
        """
        try:
            self.state = TransactionState.ABORTING

            # å›æ»šæœ¬åœ°äº‹åŠ¡
            self.local_transaction = None
            self.prepare_log = None

            self.state = TransactionState.ABORTED
            logging.info(f"Participant {self.participant_id} aborted transaction {transaction_id}")
            return True
        except Exception as e:
            logging.error(f"Participant {self.participant_id} failed to abort: {e}")
            return False

class TwoPhaseCommit:
    """ä¸¤é˜¶æ®µæäº¤åè®®å®ç°"""

    def __init__(self, coordinator_id: str):
        self.coordinator_id = coordinator_id
        self.participants: List[Participant] = []
        self.state = TransactionState.INIT
        self.current_transaction_id: Optional[str] = None

    def add_participant(self, participant: Participant):
        """æ·»åŠ å‚ä¸è€…"""
        self.participants.append(participant)

    def execute_transaction(self, transaction_id: str, transaction_data: Dict) -> bool:
        """
        æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡ã€‚

        Args:
            transaction_id: äº‹åŠ¡ID
            transaction_data: äº‹åŠ¡æ•°æ®ï¼ˆå­—å…¸ï¼Œkeyä¸ºå‚ä¸è€…IDï¼Œvalueä¸ºè¯¥å‚ä¸è€…çš„æ•°æ®ï¼‰

        Returns:
            äº‹åŠ¡æ˜¯å¦æˆåŠŸæäº¤
        """
        self.current_transaction_id = transaction_id
        self.state = TransactionState.PREPARING

        # é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ
        votes = []
        for participant in self.participants:
            participant_data = transaction_data.get(participant.participant_id, {})
            vote = participant.prepare(transaction_id, participant_data)
            votes.append(vote)

        # æ£€æŸ¥æ‰€æœ‰æŠ•ç¥¨
        if all(votes):
            # é˜¶æ®µ2ï¼šæäº¤
            self.state = TransactionState.COMMITTING
            commits = []
            for participant in self.participants:
                result = participant.commit(transaction_id)
                commits.append(result)

            if all(commits):
                self.state = TransactionState.COMMITTED
                logging.info(f"Transaction {transaction_id} committed successfully")
                return True
            else:
                # æäº¤å¤±è´¥ï¼Œéœ€è¦å›æ»š
                self.abort_transaction(transaction_id)
                return False
        else:
            # é˜¶æ®µ2ï¼šå›æ»š
            self.abort_transaction(transaction_id)
            return False

    def abort_transaction(self, transaction_id: str):
        """ä¸­æ­¢äº‹åŠ¡"""
        self.state = TransactionState.ABORTING
        for participant in self.participants:
            participant.abort(transaction_id)
        self.state = TransactionState.ABORTED
        logging.info(f"Transaction {transaction_id} aborted")

# å¤æ‚åº¦åˆ†æ
# execute_transaction: O(n) å…¶ä¸­næ˜¯å‚ä¸è€…æ•°é‡
# prepare/commit/abort: O(1) - å•æ¬¡æ“ä½œ
```

**2PCçš„é—®é¢˜**ï¼š

1. **é˜»å¡é—®é¢˜**ï¼šå¦‚æœåè°ƒè€…æ•…éšœï¼Œå‚ä¸è€…å¯èƒ½æ°¸è¿œé˜»å¡
2. **å•ç‚¹æ•…éšœ**ï¼šåè°ƒè€…æ˜¯å•ç‚¹æ•…éšœ
3. **æ€§èƒ½é—®é¢˜**ï¼šéœ€è¦ä¸¤è½®ç½‘ç»œé€šä¿¡


---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**å›½é™…å¯¹æ ‡**: 100% è¾¾æ ‡ âœ…
**å®ŒæˆçŠ¶æ€**: âœ… å·²å®Œæˆ
