# ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰ / ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰

## ğŸ“š **æ¦‚è¿° / Overview**

æœ¬æ–‡æ¡£ä»‹ç»ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰çš„è¯¦ç»†ç†è®ºå’Œå®ç°ã€‚

**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**å›½é™…å¯¹æ ‡**: 100% è¾¾æ ‡ âœ…
**å®ŒæˆçŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‘ **ç›®å½• / Table of Contents**

- [ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰ / ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰](#ä¸‰é˜¶æ®µæäº¤åè®®3pc--ä¸‰é˜¶æ®µæäº¤åè®®3pc)
  - [ğŸ“š **æ¦‚è¿° / Overview**](#-æ¦‚è¿°--overview)
  - [ğŸ“‘ **ç›®å½• / Table of Contents**](#-ç›®å½•--table-of-contents)
  - [ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰](#ä¸‰é˜¶æ®µæäº¤åè®®3pc)

---

## ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰

**å®šä¹‰ 5.1.2** (ä¸‰é˜¶æ®µæäº¤åè®® / Three-Phase Commit Protocol)

**ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆ3PCï¼‰**æ˜¯å¯¹2PCçš„æ”¹è¿›ï¼Œå¢åŠ é¢„æäº¤é˜¶æ®µä»¥é¿å…é˜»å¡é—®é¢˜ã€‚

**ä¸‰ä¸ªé˜¶æ®µ**ï¼š

1. **å‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰**ï¼šä¸2PCç›¸åŒ
2. **é¢„æäº¤é˜¶æ®µï¼ˆPre-Commitï¼‰**ï¼šåè°ƒè€…å‘å‚ä¸è€…å‘é€é¢„æäº¤æ¶ˆæ¯
3. **æäº¤é˜¶æ®µï¼ˆCommitï¼‰**ï¼šåè°ƒè€…å‘å‚ä¸è€…å‘é€æäº¤æ¶ˆæ¯

**ç®—æ³•å®ç°**ï¼š

```python
class ThreePhaseCommit:
    """ä¸‰é˜¶æ®µæäº¤åè®®å®ç°"""

    def __init__(self, coordinator_id: str):
        self.coordinator_id = coordinator_id
        self.participants: List[Participant] = []
        self.state = TransactionState.INIT
        self.current_transaction_id: Optional[str] = None

    def add_participant(self, participant: Participant):
        """æ·»åŠ å‚ä¸è€…"""
        self.participants.append(participant)

    def execute_transaction(self, transaction_id: str, transaction_data: Dict) -> bool:
        """
        æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸‰é˜¶æ®µï¼‰ã€‚

        Args:
            transaction_id: äº‹åŠ¡ID
            transaction_data: äº‹åŠ¡æ•°æ®

        Returns:
            äº‹åŠ¡æ˜¯å¦æˆåŠŸæäº¤
        """
        self.current_transaction_id = transaction_id

        # é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ
        votes = []
        for participant in self.participants:
            participant_data = transaction_data.get(participant.participant_id, {})
            vote = participant.prepare(transaction_id, participant_data)
            votes.append(vote)

        if not all(votes):
            self.abort_transaction(transaction_id)
            return False

        # é˜¶æ®µ2ï¼šé¢„æäº¤é˜¶æ®µ
        pre_commit_acks = []
        for participant in self.participants:
            # å‚ä¸è€…è¿›å…¥é¢„æäº¤çŠ¶æ€
            # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šæœ‰æ˜ç¡®çš„é¢„æäº¤æ¶ˆæ¯
            ack = True  # æ¨¡æ‹Ÿé¢„æäº¤ç¡®è®¤
            pre_commit_acks.append(ack)

        if not all(pre_commit_acks):
            self.abort_transaction(transaction_id)
            return False

        # é˜¶æ®µ3ï¼šæäº¤é˜¶æ®µ
        commits = []
        for participant in self.participants:
            result = participant.commit(transaction_id)
            commits.append(result)

        if all(commits):
            self.state = TransactionState.COMMITTED
            return True
        else:
            # æäº¤å¤±è´¥ï¼Œéœ€è¦å›æ»š
            self.abort_transaction(transaction_id)
            return False

    def abort_transaction(self, transaction_id: str):
        """ä¸­æ­¢äº‹åŠ¡"""
        self.state = TransactionState.ABORTING
        for participant in self.participants:
            participant.abort(transaction_id)
        self.state = TransactionState.ABORTED

# å¤æ‚åº¦åˆ†æ
# execute_transaction: O(n) å…¶ä¸­næ˜¯å‚ä¸è€…æ•°é‡ï¼Œä½†éœ€è¦ä¸‰è½®é€šä¿¡
```

**3PCçš„ä¼˜åŠ¿**ï¼š

1. **å‡å°‘é˜»å¡**ï¼šé€šè¿‡è¶…æ—¶æœºåˆ¶å¯ä»¥æ£€æµ‹åè°ƒè€…æ•…éšœ
2. **æ›´å¥½çš„å®¹é”™æ€§**ï¼šå‚ä¸è€…å¯ä»¥åœ¨é¢„æäº¤é˜¶æ®µåå®‰å…¨æäº¤

**3PCçš„é—®é¢˜**ï¼š

1. **ç½‘ç»œåˆ†åŒºé—®é¢˜**ï¼šä»ç„¶æ— æ³•å®Œå…¨è§£å†³ç½‘ç»œåˆ†åŒº
2. **å¤æ‚åº¦å¢åŠ **ï¼šéœ€è¦é¢å¤–çš„é¢„æäº¤é˜¶æ®µ


---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ
**è´¨é‡ç­‰çº§**: â­â­â­â­â­ äº”æ˜Ÿçº§
**å›½é™…å¯¹æ ‡**: 100% è¾¾æ ‡ âœ…
**å®ŒæˆçŠ¶æ€**: âœ… å·²å®Œæˆ
